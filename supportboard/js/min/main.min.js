"use strict";!function(e){function t(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)}function s(e,t=D){return F.storage(e,t)}function i(e){return F.translate(e)}function a(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}function n(){let e=S?SB_ADMIN_SETTINGS.sound.volume:M.sound.volume;J.audio&&(J.audio.volume=e),J.audio_out&&(J.audio_out.volume=e)}function o(){(r=e(".sb-admin, .sb-chat, .sb-tickets")).length&&typeof SB_AJAX_URL!=D?(u=r.find(".sb-list"),h=r.find(".sb-editor"),g=h.find("textarea"),v=r.find(S||A?".sb-list":"> div > .sb-scroll-area"),b=r.find(".sb-label-date-top"),p=v.find(".sb-header"),m=h.find(".sb-emoji"),f=A?r.find(".sb-profile-agent .sb-status"):null,J.enabledAutoExpand(),J.audio=r.find("#sb-audio").get(0),J.audio_out=r.find("#sb-audio-out").get(0),F.cookie("sb-check","ok",1,"set"),"ok"!=F.cookie("sb-check")?(U=!1,console.warn("Support Board: cookies not available.")):F.cookie("sb-check",!1,!1,!1),S?(n(),F.event("SBReady")):F.ajax({function:"get-front-settings",current_url:window.location.href,tickets:A,popup:!s("popup")&&!A},t=>{if(M=t,typeof SB_LOCAL_SETTINGS!=D&&e.extend(M,SB_LOCAL_SETTINGS),_=M.bot_id,y=M.dialogflow_human_takeover,N=M.agents_online,W.active=M.pusher,typeof SB_REGISTRATION_REQUIRED!=D&&(M.registration_required=SB_REGISTRATION_REQUIRED,M.tickets_registration_required=SB_REGISTRATION_REQUIRED),typeof SB_ARTICLES_PAGE!=D&&SB_ARTICLES_PAGE&&(J.automations.runAll(),J.initArticlesPage()),A&&M.tickets_manual_init||(!A||M.tickets_manual_init)&&(M.chat_manual_init||M.disable_offline&&!N||M.disable_office_hours&&!M.office_hours||M.chat_login_init&&!Q.login())||J.initChat(),M.cron&&setTimeout(function(){F.ajax({function:"cron-jobs"})},1e4),M.cron_email_piping&&setTimeout(function(){F.ajax({function:"email-piping"})},8e3),M.push_notifications_users&&W.initServiceWorker(),A&&(M.tickets_default_department&&(J.default_department=M.tickets_default_department),M.dialogflow_disable_tickets&&(M.dialogflow_active=!1,M.open_ai_active=!1)),Q.is("martfury")){let e=!1;setInterval(function(){if(a()){let t=F.cookie("XSRF-TOKEN");t&&t!=e&&(F.ajax({function:"martfury-session"}),e=t)}},3e3)}n(),Q.aecommerce.cart(),setTimeout(()=>{F.event("SBReady")},500)}),e(h).on("keydown","textarea",function(e){if(13==e.which&&(!A||M.tickets_enter_button)&&(!S||!e.ctrlKey&&!e.shiftKey))return J.submit(),e.preventDefault,!1;S&&13==e.which&&e.ctrlKey&&J.insertText("\n")}),e(r).on("keydown",".sb-dashboard-articles input",function(t){13==t.which&&e(this).next().click()}),typeof SB_DEFAULT_DEPARTMENT!==D&&(J.default_department=SB_DEFAULT_DEPARTMENT),typeof SB_DEFAULT_AGENT!==D&&(J.default_agent=SB_DEFAULT_AGENT),typeof SB_DIALOGFLOW_TAGS!==D&&(J.default_tags=SB_DEFAULT_TAGS),typeof SB_DIALOGFLOW_AGENT!==D&&(Q.dialogflow.project_id=SB_DIALOGFLOW_AGENT)):F.event("SBReady"),document.addEventListener("visibilitychange",function(){F.visibilityChange(document.visibilityState)},!1),e(r).on("click",function(){J.tab_active||F.visibilityChange()}),l=r,S&&(r=r.find(".sb-conversation")),e(v).on("scroll",function(){let t=v.scrollTop(),s=x.length;if(J.scrollHeader(),E&&(b.sbActive(!0),clearTimeout(T[0]),T[0]=setTimeout(()=>{b.sbActive(!1)},1500)),s)if(J.isBottom())b.html(e(x[s-1]).html());else for(var i=0;i<s;i++){let s=x[i].getBoundingClientRect().top;if(s>100&&s<150){let s=e(x[I[0]>t&&i>0?i-1:i]).html();s!=I[1]&&(b.html(s),I[1]=s);break}}I[0]=t}),e(u).on("click",".sb-menu-btn",function(){let t=e(this).parent().find(".sb-menu"),s=e(t).sbActive();F.deactivateAll(),s||(e(t).sbActive(!0),F.deselectAll(),S&&(SBAdmin.open_popup=t))}),L&&(e(h).on("click",".sb-textarea",function(){r.addClass("sb-header-hidden"),e(this).find("textarea").focus(),J.isBottom()&&(J.scrollBottom(),setTimeout(()=>{J.scrollBottom()},200))}),e(h).on("focusout",".sb-textarea",function(){setTimeout(()=>{r.removeClass("sb-header-hidden")},300)}),e(h).on("click",".sb-submit",function(){g.blur()}),window.addEventListener("popstate",function(){J.chat_open&&J.open(!1)})),e(u).on("click",".sb-menu li",function(){e(this).parent().sbActive(!1)}),e(h).on("click",".sb-submit",function(){J.submit()}),e("body").on("click",".sb-chat-btn,.sb-responsive-close-btn,#sb-open-chat,.sb-open-chat",function(){J.open(!J.chat_open)}),e(r).on("click",".sb-dashboard-btn",function(){J.showDashboard(),v.find(" > .sb-panel-articles > .sb-article").length&&J.showArticles(),s("open-conversation",0),R=!1}),e(r).on("click",".sb-user-conversations li",function(){J.openConversation(e(this).attr("data-conversation-id"))}),e(r).on("click",".sb-btn-new-conversation,.sb-departments-list > div,.sb-agents-list > div",function(){let t=e(this).data("id");F.null(t)||(e(this).parent().hasClass("sb-departments-list")?J.default_department=parseInt(t):J.default_agent=parseInt(t)),R="new-conversation",J.clear(),J.hideDashboard()}),e(r).on("click",".sb-btn-all-conversations",function(){r.find(".sb-dashboard-conversations").removeClass("sb-conversations-hidden")}),e(h).on("click",".sb-btn-attachment",function(){J.is_busy||h.find(".sb-upload-files").val("").click()}),e(h).on("click",".sb-attachments > div > i",function(t){return e(this).parent().remove(),g.val()||0!=h.find(".sb-attachments > div").length||J.activateBar(!1),t.preventDefault(),!1}),e(h).on("change",".sb-upload-files",function(t){J.busy(!0),e(this).sbUploadFiles(function(e){J.uploadResponse(e)}),F.event("SBAttachments")}),e(h).on("dragover",function(t){e(this).addClass("sb-drag"),clearTimeout(k),t.preventDefault(),t.stopPropagation()}),e(h).on("dragleave",function(t){k=setTimeout(()=>{e(this).removeClass("sb-drag")},200),t.preventDefault(),t.stopPropagation()}),e(h).on("drop",function(t){let s=t.originalEvent.dataTransfer.files;if(t.preventDefault(),t.stopPropagation(),s.length>0)for(var i=0;i<s.length;++i){let e=new FormData;e.append("file",s[i]),F.upload(e,function(e){J.uploadResponse(e)})}return e(this).removeClass("sb-drag"),!1}),e(r).on("click",".sb-btn-all-articles:not([onclick])",function(){J.showArticles()}),e(r).on("click",".sb-articles > div:not(.sb-title)",function(){J.showArticles(e(this).attr("data-id"))}),e(r).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",function(){J.searchArticles(e(this).parent().find("input").val(),this,e(this).parent().next())}),e(l).on("click",".sb-article [data-rating]",function(){J.articleRatingOnClick(this)}),e(u).on("click",".sb-rich-button a",function(t){let s=e(this).attr("href");if(0===s.indexOf("#")&&0===s.indexOf("#article-"))return J.showArticles(s.replace("#article-","")),t.preventDefault(),!1}),e(l).on("click",".sb-lightbox-media > i",function(){return l.find(".sb-lightbox-media").sbActive(!1),S&&(SBAdmin.open_popup=!1),!1}),e(r).on("click",".sb-image",function(){F.lightbox(e(this).html())}),e(r).on("click",".sb-slider-images .sb-card-img",function(){F.lightbox(`<img loading="lazy" src="${e(this).attr("data-value")}" />`)}),e(document).on("SBConversationLoaded",function(){s("queue")&&J.queue(s("queue"))}),e(h).on("click",".sb-btn-emoji",function(){J.showEmoji(this)}),e(m).on("click",".sb-emoji-list li",function(t){J.insertEmoji(e(this).html()),L&&clearTimeout(k)}),e(m).find(".sb-emoji-list").on("touchend",function(e){k=setTimeout(()=>{J.mouseWheelEmoji(e)},50)}),e(m).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){J.mouseWheelEmoji(e)}),e(m).find(".sb-emoji-list").on("touchstart",function(e){J.emoji_options.touch=e.originalEvent.touches[0].clientY}),e(m).on("click",".sb-emoji-bar > div",function(){J.clickEmojiBar(this)}),e(m).on("click",".sb-select li",function(){J.categoryEmoji(e(this).data("value"))}),e(m).find(".sb-search-btn input").on("change keyup paste",function(){J.searchEmoji(e(this).val())}),e(g).on("keyup",function(){J.textareaChange(this)}),e(r).on("click",".sb-privacy .sb-approve",function(){s("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),r.removeClass("sb-init-form-active"),p.find(" > div").css({opacity:1,top:0}),J.initChat(),A?SBTickets.showPanel("new-ticket"):J.isInitDashboard()||J.hideDashboard()}),e(r).on("click",".sb-privacy .sb-decline",function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),J.scrollBottom(!0)}),e(r).on("click",".sb-popup-message .sb-icon-close",function(){J.popup(!0)}),e(r).on("click",".sb-rich-message .sb-submit,.sb-rich-message .sb-select ul li",function(){let t=e(this).closest(".sb-rich-message");t[0].hasAttribute("disabled")||X.submit(t,t.attr("data-type"),this)}),e(r).on("click",".sb-rich-message .sb-input > span",function(){e(this).sbActive(!0),e(this).siblings().focus()}),e(r).on("focus focusout click",".sb-rich-message .sb-input input,.sb-rich-message .sb-input select",function(t){switch(t.type){case"focusin":case"focus":e(this).siblings().sbActive(!0);break;case"focusout":e(this).val()?e(this).siblings().addClass("sb-filled sb-active"):e(this).siblings().sbActive(!1);break;case"click":e(this).siblings().removeClass("sb-filled")}}),e(r).on("click",".sb-slider-arrow",function(){X.sliderChange(e(this).closest("[id]").attr("id"),e(this).hasClass("sb-icon-arrow-right")?"right":"left")}),e(r).on("change",'.sb-rich-message [data-type="select"] select',function(){e(this).siblings().sbActive(!0)}),e(r).on("click",'[data-type="select-input"] > div',function(){e(this).prev().sbActive(!0),e(this).next().addClass("sb-focus")}),e(r).on("focusout",'[data-type="select-input"] input,[data-type="select-input"] select',function(){let t=e(this).closest(".sb-input");t.find('input[type="tel"]').val()+t.find("select").val()==""&&t.find("span").sbActive(!1),t.find(".sb-focus").removeClass("sb-focus")}),e(r).on("click",".sb-rich-registration .sb-login-area",function(){let t=r.hasClass("sb-init-form-active");e(this).closest(".sb-rich-registration").replaceWith(X.generate({},"login",t?"sb-init-form":"")),J.scrollBottom(t)}),e(r).on("click",".sb-rich-login .sb-registration-area",function(){if(M.registration_link)document.location=M.registration_link;else{let t=r.hasClass("sb-init-form-active");e(this).closest(".sb-rich-login").replaceWith(X.generate({},"registration",t?"sb-init-form":"")),J.scrollBottom(t)}}),e(r).on("click",".sb-rich-login .sb-submit-login",function(){F.loginForm(this,!1,t=>{let s=e(this).closest(".sb-rich-login");if(a(new z(t[0])),s.hasClass("sb-init-form"))r.removeClass("sb-init-form-active"),s.remove(),R="open-conversation",J.initChat(),W.start(),J.isInitDashboard()||J.hideDashboard();else{s=s.closest("[data-id]");let e=J.conversation.getMessage(s.attr("data-id")),t=`${i("Logged in as")} *${a().name}*`;e.set("message",t),J.updateMessage(e.id,t),s.replaceWith(e.getCode()),W.started=!1,W.start()}})}),e(u).on("click",".sb-social-buttons div",function(){F.openWindow(e(this).attr("data-link"))}),e(r).on("click",".sb-close-chat",function(){J.closeChat()}),e(u).on("click",'.sb-rich-woocommerce-button a, [href="#"].sb-card-btn',function(s){let i=F.settingsStringToArray(e(this).closest(".sb-rich-message").attr("data-settings")),a="checkout"==i["link-type"]||i.checkout,n=e(this)[0].hasAttribute("data-ids")?e(this).attr("data-ids").split(","):[i.id.split("|")[e(this).parent().index()]];if(n.length){if(t(this))return;Q.wordpress.ajax("button-purchase",{product_ids:n,checkout:a,coupon:i.coupon},t=>{a?document.location=t:e(this).addClass("sb-icon-check").sbLoading(!1)})}return s.preventDefault(),!1}),e(u).on("click","#sb-waiting-list .sb-submit",function(){0==e(this).index()&&setTimeout(()=>{Q.woocommerce.waitingList("submit")},1e3)}),e(document).on("SBNewEmailAddress",function(e,t){"sb-waiting-list-email"==t.id&&Q.woocommerce.waitingList("submit")}),e(u).on("click",".sb-player-btn",function(){let t=e(this).parent().find("audio").get(0),s=e(this).hasClass("sb-icon-play");u.find("audio").each(function(){e(this).get(0).pause(),e(this).unbind("ended"),e(this).parent().find(".sb-player-btn").removeClass("sb-icon-pause").addClass("sb-icon-play")}),s?(t.play(),e(this).removeClass("sb-icon-play")):t.pause(),e(t).unbind("ended"),e(t).bind("ended",()=>{e(this).removeClass("sb-icon-pause").addClass("sb-icon-play")}),e(this).addClass("sb-icon-"+(s?"pause":"play"))}),e(u).on("click",".sb-player-speed",function(){let t=e(this).parent();if(t.find(".sb-player-btn").hasClass("sb-icon-pause")){let s=e(this).find(".sb-player-speed-number"),i=parseFloat(s.html());(i+=.5)>2&&(i=1),t.find("audio").get(0).playbackRate=i,s.html(i)}}),e(u).on("click",".sb-player-download",function(){window.open(e(this).parent().find("audio source").attr("src"))}),e(u).on("click","[data-action].sb-rich-btn",function(t){return X.calendly.load(e(this).attr("data-extra"),e(this).html(),e(this).closest("[data-id]").attr("data-id")),t.preventDefault(),!1}),e(r).on("click",".sb-overlay-panel > div:first-child i",function(){r.find(".sb-overlay-panel").sbActive(!1)}),e(l).on("click",".sb-search-btn > i",function(){let t=e(this).parent(),s=e(t).sbActive();s&&(setTimeout(()=>{e(t).find("input").val("")},50),setTimeout(()=>{e(t).find("input").trigger("change")},550)),e(t).sbActive(!s),e(t).find("input").focus(),l.find(".sb-select ul").sbActive(!1)}),e(l).on("click",".sb-select",function(){let t=e(this).find("ul"),s=t.hasClass("sb-active");e(l).find(".sb-select ul").sbActive(!1),t.setClass("sb-active",!s),S&&(SBAdmin.open_popup=!s&&this)}),e(l).on("click",".sb-select li",function(){let t=e(this).closest(".sb-select"),s=e(this).data("value");var i=e(t).find(`[data-value="${s}"]`);e(t).find("li").sbActive(!1),e(t).find("p").attr("data-value",s).html(e(i).html()),e(i).sbActive(!0)}),e(l).on("click",".sb-input-image .image",function(){c=e(this).parent(),h.find(".sb-upload-files").click()}),e(l).on("click",".sb-input-image .image > .sb-icon-close",function(t){return e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1})}var r,l,c,d,u,h,g,p,f,m,v,b,_,y,w,S=!1,A=!1,k=!1,C=!1,T=[!1,!1],$=!1,B=[],x=!1,E=!1,I=[9999999,""],j=document.title,M={},L=e(window).width()<465,R="",N=!1,D="undefined",U=!0,O=6e4*(new Date).getTimezoneOffset(),q=!1,G=!1,P="visible";e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=(t.scrollHeight>350?350:t.scrollHeight)+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(s){e(t).manualExpandTextarea()},!1)}}),function(){var e=[].slice;String.prototype.autoLink=function(){var t,s,i,a,n,o,r;return o=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~_|])/gi,0<(n=1<=arguments.length?e.call(arguments,0):[]).length?(a=n[0],t=a.callback,i=function(){var e;for(s in e=[],a)r=a[s],"callback"!==s&&e.push(" "+s+"='"+r+"'");return e}().join(""),this.replace(o,function(e,s,a){return""+s+(("function"==typeof t?t(a):void 0)||"<a href='"+a+"'"+i+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);var F={ajax:function(t,s=!1){w?(w[0].push(t),w[1].push(s)):(w=[[t],[s]],setTimeout(function(){let i=w[1],n={"login-cookie":F.loginCookie()};a()&&(n.user_id=a().id),typeof SB_LANG!=D&&(n.language=SB_LANG),q&&(n.cloud=q),F.getURL("debug")&&(n.debug=!0),e.ajax({method:"POST",url:SB_AJAX_URL,data:e.extend({function:"ajax_calls",calls:w[0]},n)}).done(e=>{let a;if(Array.isArray(e))a=e;else if("invalid-session"===e)setTimeout(()=>{F.reset()},1e3);else try{a=JSON.parse(e)}catch(s){return S&&(SBAdmin.conversations.busy=!1),J.is_busy_update=!1,J.busy(!1),console.log(e),void F.error(e.length>500?e.substr(0,500)+"... Check the console for more details.":e,`SBF.ajax.${t.function}`)}for(var n=0;n<a.length;n++){let e=a[n];Array.isArray(e)||(e=a),"success"==e[0]?(s=i[n])&&s(e[1]):F.errorValidation(e)?s&&s(e):(S&&"security-error"==e[1]&&setTimeout(()=>{F.reset()},1e3),J.is_busy_update=!1,J.busy(!1),F.error(JSON.stringify(e).replace(/\\/g,"").replace(/\"/g,"").replace(/\[/g,"").replace(/\]/g,"").replace("error,",""),t.function))}}),w=!1},100))},cors:function(e="GET",t,s){let i=new XMLHttpRequest;if("withCredentials"in i)i.open(e,t,!0);else{if(typeof XDomainRequest==D)return!1;(i=new XDomainRequest).open(e,t)}i.onload=function(){s(i.responseText)},i.onerror=function(){return!1},i.send()},upload:function(e,t){q&&e.append("cloud",q),jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},UTC:function(e){return new Date(e).getTime()-O},null:function(e){return typeof e===D||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||typeof e.length==D)||e===D},deactivateAll:function(){l.find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActive(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e=!1,t=!1){if(t||(t=location.search),0==e){for(var s=t.split("?").pop().split("&"),i={},a=0;a<s.length;a++){var n=s[a].split("=");i[n[0]]=F.escape(n[1])}return i}return t.indexOf("?")>0&&(t=t.substr(0,t.indexOf("?"))),F.escape(decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(t)||[,""])[1].replace(/\+/g,"%20")||""))},URL:function(){return window.location.href.substr(0,window.location.href.indexOf("?"))},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",s=0,i=t.length;s<i;s++)e=e.replace(new RegExp(t.charAt(s),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(s));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,"")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,s=!1){let a;if("0000-00-00 00:00:00"==e)return"";if(e.indexOf("-")>0){let t=e.split(/[- :]/);a=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])}else{let t=e.split(/[. :]/);a=new Date(t[2],t[1]-1,t[0],t[3],t[4],t[5])}let n=new Date,o=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())),r=(n-o)/864e5*(s?-1:1),l=[i("Sunday"),i("Monday"),i("Tuesday"),i("Wednesday"),i("Thursday"),i("Friday"),i("Saturday")],c=o.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit"});return"0"===c.charAt(0)&&(c.includes("PM")||c.includes("AM"))&&(c=c.substring(1)),r<1&&n.getDate()==o.getDate()?t?`<span>${i("Today")}</span> <span>${c}</span>`:`<span data-today>${c}</span>`:r<7?`<span>${l[o.getDay()]}</span>${t?` <span>${c}</span>`:""}`:`<span>${o.toLocaleDateString()}</span>${t?` <span>${c}</span>`:""}`},unix:function(e){let t=e.split(/[- :]/);return Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5])},getLocationTimeString:function(e,t){if(e.timezone){let s={};s.timezone=e.timezone.value,s.country=e.country?e.country.value:s.timezone.split("/")[0].replace(/_/g," "),s.city=e.city?e.city.value:s.timezone.split("/")[1].replace(/_/g," "),F.cors("GET","https://worldtimeapi.org/api/timezone/"+s.timezone,function(e){if(e=JSON.parse(e),F.null(e)||e.error)F.error(e,"SBF.getLocationTimeString()"),t(responseonSuccess);else{let a=e.datetime.replace("T"," ");t(`${new Date(a.substr(0,a.indexOf("."))).toLocaleString([],{hour:"2-digit",minute:"2-digit"})} ${i("in")} ${s.city?s.city:""}${s.country?", "+s.country:""}`)}})}},dateDB:function(e){return"now"==e?((e=(new Date).toISOString().replace("T"," ")).indexOf(".")>0&&(e=e.substr(0,e.indexOf("."))),e):`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`},updateUsersActivity:function(e,t,s){W.active?s(W.online_ids.includes(t)?"online":"offline"):F.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t,check_slack:!S&&M.slack_active},e=>{s("online"===e?"online":"offline")})},search:function(e,t){(e=e.toLowerCase())!=d?(clearTimeout(k),k=setTimeout(function(){d=e,t()},500)):l.find(".sb-search-btn i").sbLoading(!1)},searchClear:function(t,s){e(t).next().val()&&(e(t).next().val(""),s())},error:function(e,t){if(!S||!SBAdmin.is_logout)throw e instanceof Error&&(e=e.message),"."==e[e.length-1]&&(e=e.slice(0,-1)),e.includes("Support Board Error")&&(e=e.replace("Support Board Error ","").replace("]:","]")),S&&e&&!t.includes("update-users-last-activity")&&!t.startsWith("security-error")&&SBAdmin.dialog(`[Error] [${t}] ${e}. Check the console for more details.`,"info",!1,"error"),l.find(".sb-loading").sbLoading(!1),J.busy(!1),F.event("SBError",{message:e,function_name:t}),new Error(`Support Board Error [${t}]: ${e}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(t,s=!1,a=!1){if(!(t=e(t)).sbLoading()){s=!1===s?t.closest(".sb-rich-login"):e(s);let n=e.trim(s.find("#email input").val()),o=e.trim(s.find("#password input").val());n&&o?(F.ajax({function:"login",email:n,password:o},e=>{if(e&&Array.isArray(e)){if(!S&&this.isAgent(e[0].user_type))Y.showErrorMessage(s,"You cannot sign in as an agent."),J.scrollBottom();else{let t=new z(e[0]);t.set("conversation_id",!!J.conversation&&J.conversation.id),this.loginCookie(e[1]),this.event("SBLoginForm",t),a&&a(e)}"wp"==F.setting("wp-users-system")&&Q.wordpress.ajax("wp-login",{user:n,password:o})}else s.find(".sb-info").html(i("ip-ban"===e?"Too many login attempts. Please retry again in a few hours.":"Invalid email or password.")).sbActive(!0),S||J.scrollBottom();t.sbLoading(!1)}),s.find(".sb-info").html("").sbActive(!1),t.sbLoading(!0)):s.find(".sb-info").html(i("Please insert email and password.")).sbActive(!0)}},loginCookie:function(e=!1){if(!1===e)return this.cookie("sb-login")?this.cookie("sb-login"):s("login");M.cloud?s("login",e):this.cookie("sb-login",e,3650,"set")},login:function(e="",t="",s="",i="",a=!1){F.ajax({function:"login",email:e,password:t,user_id:s,token:i},e=>!(0==e||!Array.isArray(e))&&(this.loginCookie(e[1]),a&&a(e),!0))},logout:function(e=!0){J.stopRealTime(),this.cookie("sb-login","","",!1),this.cookie("sb-cloud","","",!1),s("open-conversation",""),s("login",""),J.conversations=!1,a(!1),typeof sb_beams_client!==D&&sb_beams_client.stop(),F.ajax({function:"logout"},()=>{F.event("SBLogout"),e&&setTimeout(()=>{location.reload()},500)})},activeUser:function(){return a()},getActiveUser:function(e=!1,t){let i=Q.login();!i&&(s("wp-login")||s("whmcs-login")||s("perfex-login")||s("aecommerce-login"))&&(this.cookie("sb-login","","","delete"),a(!1),s("login",""),s("wp-login",""),s("whmcs-login",""),s("perfex-login",""),s("aecommerce-login","")),F.ajax({function:"get-active-user",db:e,login_app:JSON.stringify(i),user_token:F.getURL("token")},e=>{if(!e)return t(),!1;if(e.cookie&&F.loginCookie(e.cookie),e.user_type)if(!S&&F.isAgent(e.user_type)){let e="You are logged in as both agent and user. Logout or use another browser, Incognito or Private mode, to login as user. Force a logout by running the function SBF.reset() in the console.";s("double-login-alert")||(s("double-login-alert",!0),alert(e)),console.warn("Support Board: "+e),F.event("SBDoubleLoginError")}else a(new z(e,e.phone?{phone:e.phone}:{})),W.start(),i&&s(i[1]+"-login",!0),t(),F.event("SBActiveUserLoaded",e)})},reset:function(){let e=["sb-login","sb-cloud","sb-dialogflow-disabled"];for(var t=0;t<e.length;t++)this.cookie(e[t],"",0,!1);try{localStorage.removeItem("support-board")}catch(e){}this.logout()},lightbox:function(t){let s=e(S?l:r).find(".sb-lightbox-media");s.sbActive(!0).find(" > div").html(t),S&&(SBAdmin.open_popup=s)},storage:function(e,t=D){try{if(typeof localStorage==D)return!1}catch(e){return!1}let s=localStorage.getItem("support-board");if(s=null===s?{}:JSON.parse(s),t===D)return e in s&&s[e];t?s[e]=t:delete s[e],localStorage.setItem("support-board",JSON.stringify(s))},storageTime:function(e,t=!1){let i=new Date;if(!1!==t)return 0==s(e)||i.getTime()-s(e)>36e5*t;s(e,i.getTime())},cookie:function(e,t=!1,s=!1,i="get",a=!1){let n="https:"==location.protocol?"SameSite=None;Secure;":"",o=window[S?"SB_ADMIN_SETTINGS":"CHAT_SETTINGS"],r=o&&o.cookie_domain?"domain="+o.cookie_domain+";":"";if("get"==i){if(!U)return this.storage(e);let t=document.cookie.split(";");for(var l=0;l<t.length;l++){for(var c=t[l];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(e)){let t=c.substring(e.length+1,c.length);return!this.null(t)&&t}}return!1}if("set"==i)if(U){let i=new Date;i.setTime(i.getTime()+s*(a?1:86400)*1e3),document.cookie=e+"="+t+";expires="+i.toUTCString()+";path=/;"+n+r}else this.storage(e,t);else this.cookie(e)&&(U?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+n+r:this.storage(e,""))},setting:function(e,t=-1){if(-1===t)return typeof M!==D&&e in M&&M[e];typeof M!==D&&(M[e]=t)},shortcode:function(e){return X.shortcode(e)},event:function(t,s){e(document).trigger(t,s);let i=S?typeof SB_ADMIN_SETTINGS!==D&&SB_ADMIN_SETTINGS.webhooks:M.webhooks,a={SBSMSSent:"sms-sent",SBLoginForm:"login",SBRegistrationForm:"registration",SBUserDeleted:"user-deleted",SBNewMessagesReceived:"new-message",SBNewConversationReceived:"new-conversation",SBSlackMessageSent:"slack-message-sent",SBMessageDeleted:"message-deleted",SBRichMessageSubmit:"rich-message",SBNewEmailAddress:"new-email-address"};if(i&&t in a){if(!0!==i&&(Array.isArray(i)||(i=i.replace(/ /g,"").split(",")),!i.includes(a[t])))return;F.ajax({function:"webhooks",function_name:t,parameters:s})}},translate:function(e){if(!S&&F.null(M)||S&&typeof SB_TRANSLATIONS===D)return e;let t=S?SB_TRANSLATIONS:M.translations;return t&&t[e]&&t[e]?t[e]:e},escape:function(e){return e?e.replaceAll("<script","&lt;script").replaceAll("</script","&lt;/script").replaceAll("javascript:","").replaceAll("onclick=","").replaceAll("onerror=","").replaceAll("ontoggle=",""):e},visibilityChange:function(e=""){P=e,"hidden"==e?(S||J.stopRealTime(),J.tab_active=!1):(a()&&!S&&J.startRealTime(),J.tab_active=!0,clearInterval($),clearInterval(J.audio_interval),J.conversation&&J.conversation.updateMessagesStatus(),S&&typeof SBAdmin!==D&&SBAdmin.conversations.hideNewLabel(),document.title=j)},settingsStringToArray:function(e){if(this.null(e))return[];let t=[];e=e.split(",");for(var s=0;s<e.length;s++){let i=e[s].split(":");t[i[0]]="false"!=i[1]&&("true"==i[1]||i[1])}return t},openWindow:function(e,t=550,s=350){let i=screen.width/2-t/2,a=screen.height/2-s/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+s+", top="+a+", left="+i),!1},convertUTCDateToLocalDate:function(e,t=0){return e=new Date(e),e=new Date(e.getTime()+36e5*t),new Date(e.getTime()+-1*O)},loadResource:function(e,t=!1,s=!1,i=!1){let a=document.createElement(t?"script":"link");e?(t?a.src=e:a.href=e,a.type=t?"text/javascript":"text/css"):a.innerHTML=i,s&&(a.onload=function(){s()}),t||(a.rel="stylesheet"),document.head.appendChild(a)},debounce:function(e,t,s=500){t in B||(B[t]=!0,e(),setTimeout(()=>{delete B[t]},s))}},W={channels:{},channels_presence:[],active:!1,pusher:!1,started:!1,pusher_beams:!1,initialized:!1,online_ids:[],init_push_notifications:!1,sw:!1,init:function(t=!1){if(W.active){if(this.pusher)return!t||t();if(!t)return;e(window).one("SBPusherInit",()=>{t()}),this.initialized=!0,e.getScript("https://js.pusher.com/7.0/pusher.min.js",()=>{this.pusher=new Pusher(S?SB_ADMIN_SETTINGS.pusher_key:M.pusher_key,{cluster:S?SB_ADMIN_SETTINGS.pusher_cluster:M.pusher_cluster,authEndpoint:SB_URL+"/include/pusher.php",auth:{params:{login:F.loginCookie()}}}),F.event("SBPusherInit")},!0)}},initPushNotifications:function(){(a()||S)&&e.getScript("https://js.pusher.com/beams/1.0/push-notifications-cdn.js",()=>{window.navigator.serviceWorker.ready.then(e=>{this.pusher_beams=new PusherPushNotifications.Client({instanceId:S?SB_ADMIN_SETTINGS.push_notifications_id:M.push_notifications_id,serviceWorkerRegistration:e}),this.pusher_beams.start().then(()=>this.pusher_beams.setDeviceInterests(S?[SB_ACTIVE_AGENT.id,"agents"]:[a().id,"users"])).catch(console.error),this.init_push_notifications=!1})},!0)},initServiceWorker:function(){navigator.serviceWorker&&(navigator.serviceWorker.register(S||"undefined"!=typeof SB_CLOUD_SW?SB_URL.replace("/script","")+"/sw.js?v=3.6.5":M.push_notifications_url+"?v=3.6.5").then(e=>{e.update(),this.sw=e}).catch(function(e){console.warn(e)}),navigator.serviceWorker.onmessage=function(e){S?e.data.conversation_id?(SBAdmin.conversations.openConversation(e.data.conversation_id,e.data.user_id),SBAdmin.conversations.update()):e.data.user_id&&(SBAdmin.profile.show(e.data.user_id),J.playSound()):"sb-open-chat"==e.data&&J.open()})},start:function(){S||this.started||!a()||(this.active&&this.init(()=>{this.event("client-typing",e=>{e.user_id==J.agent_id&&J.conversation&&e.conversation_id==J.conversation.id&&(J.typing(-1,"start"),clearTimeout(C),C=setTimeout(()=>{J.typing(-1,"stop")},1e3))}),this.event("new-message",e=>{!(e&&a()&&e.conversation_id)||a().getConversationByID(e.conversation_id)||J.conversation&&J.conversation.id==e.conversation_id?J.update():J.updateConversations()}),this.presence(1,()=>{this.started=!0,J.automations.runAll()})}),M.push_notifications&&(typeof Notification!=D&&"granted"==Notification.permission?this.initPushNotifications():this.init_push_notifications=!0))},subscribe:function(e,t=!1){if(!this.pusher)return this.init(()=>{this.subscribe(e,t)});e=this.cloudChannelRename(e);let s=this.pusher.subscribe(e);s.bind("pusher:subscription_error",e=>console.log(e)),s.bind("pusher:subscription_succeeded",()=>{this.channels[e]=s,t&&t()})},event:function(e,t,s="private-user-"+a().id){if(!this.pusher)return this.init(()=>{this.event(e,t,s)});let i=s;(s=this.cloudChannelRename(s))in this.channels?(this.channels[s].unbind(e),this.channels[s].bind(e,e=>{t(e)})):this.subscribe(i,()=>{this.event(e,t,i)})},trigger:function(e,t={},s="private-user-"+a().id){if(0==e.indexOf("client-"))return this.channels[this.cloudChannelRename(s)].trigger(e,t);F.ajax({function:"pusher-trigger",channel:s,event:e,data:t},e=>e)},presence:function(e=1,t){if(!this.pusher)return this.init(()=>{this.presence()});let s=this.pusher.subscribe(this.cloudChannelRename("presence-"+e));s.bind("pusher:subscription_succeeded",s=>{if(s.count>98)return this.subscribe(e+1);s.each(e=>{this.presenceCheck(e)&&this.online_ids.push(e.id)}),J.updateUsersActivity(),t&&t()}),s.bind("pusher:subscription_error",e=>console.log(e)),s.bind("pusher:member_added",e=>{this.presenceCheck(e)&&this.presenceAdd(e.id),S&&SBAdmin.users.onlineUserNotification(e)}),s.bind("pusher:member_removed",e=>{this.presenceRemove(e.id)}),this.channels_presence.push(s),!S&&M.slack_active&&(this.event("add-user-presence",e=>{this.presenceAdd(e.agent_id)}),F.ajax({function:"slack-presence",list:!0},e=>{for(var t=0;t<e.length;t++)this.presenceAdd(e[t]);J.updateUsersActivity()}))},presenceCheck:function(e){let t=F.isAgent(e.info.user_type);return(S&&!t||!S&&t)&&!this.online_ids.includes(e.id)},presenceAdd:function(e){typeof e==D||this.online_ids.includes(e)||(this.online_ids.push(e),this.presenceUpdateAdmin(e),J.updateUsersActivity())},presenceRemove:function(e){if(typeof e==D)return;let t=this.online_ids.indexOf(e);-1!==t?(this.online_ids.splice(t,1),this.presenceUpdateAdmin(e),J.updateUsersActivity()):S&&l.find(`.sb-conversation-busy[data-agent="${e}"]`).remove()},presenceUnsubscribe:function(){for(var e=0;e<this.channels_presence.length;e++)this.channels_presence[e].unsubscribe(this.cloudChannelRename("presence-"+(e+1)))},presenceUpdateAdmin:function(e){S&&(l.find(".sb-area-users.sb-active").length&&SBAdmin.users.update(),a()&&a().id==e&&SBAdmin.users.updateUsersActivity())},pushNotification:function(e){let t=S?SB_ACTIVE_AGENT.profile_image:a().image;F.ajax({function:"push-notification",title:S?SB_ACTIVE_AGENT.full_name:a().name,message:(new V).strip(e),icon:t.indexOf("user.svg")>0?M.notifications_icon:t,interests:J.getRecipientUserID(),conversation_id:0!=J.conversation&&J.conversation.id},e=>e)},cloudChannelRename:function(e){return M.cloud||S&&SB_ADMIN_SETTINGS.cloud?e+"-"+(S?SB_ADMIN_SETTINGS.cloud.cloud_user_id:M.cloud.cloud_user_id):e}};window.SBF=F,window.SBPusher=W,window.sb_current_user=!1,e.fn.sbActive=function(t=-1){return-1===t?e(this).hasClass("sb-active"):(e(this).setClass("sb-active",t),this)},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(e(this).setClass("sb-loading",t),this)},e.fn.sbTogglePopup=function(t=!1){let s=!0;return S&&(SBAdmin.open_popup=!1),e(this).sbActive()?(e(this).sbActive(!1),l.removeClass("sb-popup-active"),s=!1):(l.addClass("sb-popup-active"),l.find(".sb-popup").sbActive(!1),t&&e(this).css("left",e(t).offset().left+15).sbActive(!0),S&&setTimeout(()=>{SBAdmin.open_popup=this},500),F.deselectAll()),s},e.fn.sbUploadFiles=function(t){let s=e(this).prop("files");for(var a=0;a<s.length;a++){let e=s[a],n=e.size/1048576,o=S?SB_ADMIN_SETTINGS.max_file_size:M.max_file_size;if(n>o){let e=i("Maximum upload size is {R}MB. File size: {R2}MB.").replace("{R}",o).replace("{R2}",n.toFixed(2));S?SBAdmin.dialog(e,"info"):alert(e)}let r=new FormData;r.append("file",e),F.upload(r,t)}e(this).value=""},e.fn.setProfile=function(t=!1,s=!1){return F.null(t)&&(t=a()?a().name:""),F.null(s)&&(s=a()?a().image:SB_URL+"/media/user.svg"),t&&e(this).removeClass("sb-profile-empty"),e(this).find("img").attr("src",s),e(this).find(".sb-name").html(t),this},e.fn.setClass=function(t,s=!0){return s?e(this).addClass(t):e(this).removeClass(t),this};class z{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return this.get("id")?this.get("id"):this.get("user_id")}get type(){return this.get("user_type")}get email(){return this.get("email")}get name(){return this.details.first_name?this.details.first_name+(this.details.last_name?" "+this.details.last_name:""):""}get nameBeautified(){return this.details.last_name&&"#"!=this.details.last_name.charAt(0)?this.name:M.visitor_default_name}get image(){return this.get("profile_image")}get language(){let e=this.getExtra("language");return e||(e=this.getExtra("browser_language")),e?e.value.toLowerCase():""}get(e){return e in this.details&&!F.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!F.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&e.details){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(e){this.id?F.ajax({function:"get-user",user_id:this.id,extra:!0},t=>{this.processArray(t),e()}):F.error("Missing user ID","SBUser.update")}getConversations(e=!1,t){this.id?F.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t,agent:F.isAgent(this.type)},t=>{if(!F.errorValidation(t)){let i=[];for(var s=0;s<t.length;s++)if(J.isConversationAllowed(t[s].source)&&(3!=t[s].status_code||!M.close_chat)){let e=new H([new V(t[s])],{id:t[s].id,status_code:t[s].status_code,department:t[s].department,agent_id:t[s].agent_id,user_id:t[s].user_id,title:t[s].title});i.push(e)}this.conversations=i,e&&e(i)}}):F.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="",s=J.conversation?J.conversation.id:-1;e||(e=this.conversations);for(var i=0;i<e.length;i++)e[i]instanceof H?t+=`<li ${s==e[i].id?'class="sb-active" ':""}data-conversation-status="${e[i].status_code}" data-conversation-id="${e[i].id}" data-department="${e[i].get("department")}">${e[i].getCode()}</li>`:F.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return t}getFullConversation(e=!1,t=!1){!1!==e?F.ajax({function:"get-conversation",conversation_id:e},e=>{let s=[];if(e){if("agent-not-authorized"===e)return void(window.location.href=F.URL());for(var i=0;i<e.messages.length;i++)s.push(new V(e.messages[i]))}t&&t(new H(s,!!e&&e.details))}):F.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e,t=!1){for(var s=0;s<this.conversations.length;s++)if(this.conversations[s].id==e)return t?s:this.conversations[s];return!1}addConversation(e){if(e instanceof H){let s=e.id,i=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==s){this.conversations[t]=e,i=!1;break}return i&&this.conversations.unshift(e),i}F.error("Conversation not of type SBConversation","SBUser.addConversation")}removeConversation(e){let t=this.getConversationByID(e,!0);!1!==t&&this.conversations.splice(t,1)}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){this.id?F.ajax({function:"delete-user",user_id:this.id},()=>(F.event("SBUserDeleted",this.id),e(),!0)):F.error("Missing user ID","SBUser.delete")}}window.SBUser=z;class V{constructor(e={}){this.details=e,this.details.first_name&&(this.details.full_name=this.details.first_name+" "+this.details.last_name),e.message_status_code&&(e.status_code=e.message_status_code),delete e.message_status_code,delete e.source,delete e.extra,delete e.title,delete e.tags,delete e.agent_id,delete e.department;let t=this.get("payload");if(t)try{var s=JSON.parse(this.get("payload").replace("\\'","'"));t=s&&"object"==typeof s?s:{}}catch(e){t={}}else t={};this.set("payload",t)}get id(){return this.get("id")}get attachments(){return F.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get message(){return this.get("message")}get(e){return e in this.details&&!F.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){let s=this.get("payload");if(!1!==e&&!1!==t)s[e]=t,this.set("payload",s);else if(!1!==e)return e in s?s.key:!(!s.id||s.id!=e)&&s;return s}getCode(e=!1){let t=F.isAgent(this.details.user_type),s=S?SBAdmin.conversations.messageMenu(t):"",i=e?this.get("translation"):!this.message&&this.payload.preview?this.payload.preview:this.message,a=this.attachments,n="",o="",r=S&&SB_ADMIN_SETTINGS.show_profile_images||!S&&(t&&!M.hide_agents_thumb||!t&&M.display_users_thumb)?`<div class="sb-thumb"><img loading="lazy" src="${this.details.profile_image}"><div class="sb-tooltip"><div>${this.details.full_name}</div></div></div>`:"",l=(S&&t||!S&&!t?"sb-right":"")+(r?" sb-thumb-active":""),c="",d=!S&&t&&M.sender_name||S&&"chat-admin"==SB_ADMIN_SETTINGS.sender_name?`<span class="sb-agent-name">${this.get("full_name")}</span>`:"";if(!i&&!a.length)return"";if(t){let e=(i=i.replace(/\n/g,"<br>")).match(/\[.+?\]/g)||[],t=!1,s=e.length;for(u=0;u<s;u++){let s=X.shortcode(e[u]);if(s[0]){let a=X.generate(s[1],s[0]);a&&("["!=i.charAt(0)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-top")),"]"!=i.charAt(i.length-1)&&(a=a.replace("sb-rich-message","sb-rich-message sb-margin-bottom")),i=i.replace(e[u],"{{RM}}"),i=this.render(i).replace("{{RM}}",a),t=!0,c=`data-type="${s[0]}"`)}}t&&(l+=" sb-rich-cnt",s>1&&(c='data-type="multiple"')),s||(i=this.render(i))}else i=this.render(i);if(a.length){n='<div class="sb-message-attachments">';for(var u=0;u<a.length;u++){let e=a[u][1];/.jpg|.jpeg|.png|.gif|.webp/.test(e)?o+=`<div class="sb-image${e.includes(".png")?" sb-image-png":e.includes("sticker_")?" sb-image-sticker":""}"><img loading="lazy" src="${e}" /></div>`:/.mp3|.ogg|.wav/.test(e)?n+=`<div class="sb-player"><div class="sb-player-btn sb-icon-play"></div><div class="sb-player-speed"><div class="sb-player-speed-number">1</div><div class="sb-icon-close"></div></div><div class="sb-player-download sb-icon-arrow-down"></div><audio><source src="${e}" type="audio/mpeg"></audio></div>`:n+=`<a rel="noopener" target="_blank" href="${e}">${a[u][0]}</a>`}n+="</div>"}return`<div data-id="${this.details.id}" class="${l}" ${c}>${r}<div class="sb-cnt"><div class="sb-message${o&&!i?" sb-message-media":""}">${d}${i}${o}</div>${n}<div class="sb-time">${F.beautifyTime(this.details.creation_time,!0)}${S&&t&&2==this.details.status_code?'<i class="sb-icon-check"></i>':""}</div></div>${s}</div>`}render(t=!1){!1===t&&(t=""+this.details.message);let s=t.length,i=t.match(/```([\s\S]*)```/)||[];for(n=0;n<i.length;n++)t=t.replace(i[n],"[code-"+n+"]");t=(t=(t=(t=(t=t.replace(/(?:\r\n|\r|\n)/g,"<br>")).replace(/\*([^\**]+)\*/g,"<b>$1</b>")).replace(/\__([^\____]+)\__/g,"<i>$1</i>")).replace(/\~([^\~~]+)\~/g,"<del>$1</del>")).replace(/\`([^\``]+)\`/g,"<code>$1</code>");let a=["cede","ubbed","udada","ucced"];for(n=0;n<a.length;n++)t=t.replaceAll(a[n],`SBR${n}`);t=t.replace(/u([0-9a-f]{4,5})/im,"&#x$1;");for(n=0;n<a.length;n++)t=t.replaceAll(`SBR${n}`,a[n]);((6==s||5==s)&&t.startsWith("&#x")||s<3&&t.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(t=`<span class="emoji-large">${t}</span>`),t.includes("http")&&(t=t.autoLink({target:"_blank"}));for(var n=0;n<i.length;n++)t=t.replace("[code-"+n+"]","<pre>"+e.trim(e.trim(i[n]).substr(3,i[n].length-6).replace(/(?:\r\n|\r|\n)/g,"<br>")))+"</pre>";return t.replace(/&amp;lt;/g,"&lt;")}strip(e=!1){!1===e&&(e=""+this.details.message);let t=[e.match(/\*([^\**]+)\*/g),e.match(/\__([^\____]+)\__/g),e.match(/\~([^\~~]+)\~/g),e.match(/\`([^\``]+)\`/g)],s=["*","__","~","`"];for(var i=0;i<t.length;i++){let n=t[i];if(!F.null(n))for(var a=0;a<n.length;a++)e=e.replace(n[a],n[a].replaceAll(s[i],""))}return e}}window.SBMessage=V;class H{constructor(e,t){this.details=F.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof V?this.messages=e:F.error("Messages not of type SBMessage","SBConversation.constructor"))):F.error("Message array not of type Array","SBConversation.constructor")}get id(){return this.get("id")?this.get("id"):this.get("conversation_id")}get status_code(){return this.get("status_code")}get(e){if(e in this.details&&!F.null(this.details[e]))return this.details[e];if("title"==e){if(!F.null(this.details.first_name))return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t].set("index",t),this.messages[t];return!1}getLastMessage(){for(var e=this.messages.length-1;e>-1;e--)if(this.messages[e].message||this.messages[e].attachments.length)return this.messages[e];return!1}getLastUserMessage(e=!1,t=!1){!1===e&&(e=this.messages.length-1);for(var s=e;s>-1;s--){let e=this.messages[s],i=e.get("user_type");if((e.message||e.attachments.length)&&(!t&&!F.isAgent(i)||!0===t&&("agent"==i||"admin"==i)||"bot"==t&&"bot"==i||"no-bot"==t&&"bot"!=i||"all"==t&&F.isAgent(i)))return this.messages[s].set("index",s-1),this.messages[s]}return!1}getUserMessages(e="user"){let t=[],s="user"==e?["visitor","lead","user"]:"agents"==e?["agent","admin"]:["bot"];for(var i=0;i<this.messages.length;i++)s.includes(this.messages[i].get("user_type"))&&(this.messages[i].set("index",i),t.push(this.messages[i]));return t}updateMessage(e,t){if(t instanceof V){for(var s=0;s<this.messages.length;s++)if(this.messages[s].id==e)return this.messages[s]=t,!0}else F.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof V&&this.messages.push(e[t]);else e instanceof V?this.messages.push(e):F.error("Messages not of type SBMessage","SBConversation.addMessages()");return this}getCode(){let e=this.messages.length;if(e){let t=this.messages[e-1],s=t.message;if(!1!==s.indexOf("[")){let e=s.match(/\[.+?\]/g)||[];if(e.length){let t=X.shortcode(e[0]);t[0]&&(s=s.replace(e[0],i(F.null(t[1].message)?F.null(t[1].title)?"":t[1].title:t[1].message)))}}let a=this.get("title");return(!a||A&&M.tickets_conversations_title_user)&&(a=F.isAgent(t.get("user_type"))?t.get("full_name"):i("You")),`<div class="sb-conversation-item" data-user-id="${t.get("user_id")}"><img loading="lazy" src="${t.get("profile_image")}"><div><span class="sb-name">${a}</span><span class="sb-time">${F.beautifyTime(t.get("last_update_time"))}</span></div><div class="sb-message">${s.length>114?s.substr(0,114)+" ...":s}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){let s=[];for(var i=0;i<this.messages.length;i++){let a=this.messages[i].message;(t&&a==e||!t&&a.includes(e))&&(this.messages[i].set("index",i),s.push(this.messages[i]))}return s}getAttachments(){let e=[];for(var t=0;t<this.messages.length;t++){let i=this.messages[t].attachments;for(var s=0;s<i.length;s++){let a=i[s][1];e.push([i[s][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}}return e}updateMessagesStatus(e=!1){if(e)for(t=0;t<this.messages.length;t++){let s=this.messages[t].id;if(e.includes(s)){let e=u.find(`[data-id="${s}"] .sb-time`);e.find("i").length||e.append('<i class="sb-icon-check"></i>')}}else if(!S&&"visible"==P){e=[];for(var t=0;t<this.messages.length;t++){let s=this.messages[t];F.isAgent(s.get("user_type"))&&2!=s.status_code&&(e.push(s.id),s.set("status_code",2))}e.length&&F.ajax({function:"update-messages-status",message_ids:e})}}}window.SBConversation=H;var J={rich_messages_list:["chips","buttons","select","inputs","table","list"],emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,is_busy_update:!1,is_busy_populate:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,id_last_message:0,id_last_message_conversation:0,datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_out:!1,audio_interval:!1,tab_active:!0,notifications:[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dashboard:!1,articles:!1,articles_categories:!1,articles_allowed_ids:!1,articles_category:!1,slack_channel:[-1,-1],skip:!1,queue_interval:!1,departments:!1,default_department:null,default_agent:null,default_tags:null,offline_message_set:!1,sendMessage:function(t=-1,s="",n=[],o=!1,r=!1,l=!1){let c=y&&Q.dialogflow.active(),d=!1;if(!a()&&!S)return void this.addUserAndLogin(()=>this.sendMessage(t,s,n,o,r),!0);if(!this.conversation){let e=!S&&a().getLastConversation();if(!e||"new-conversation"==R||J.default_department&&J.default_department!=e.get("department")||J.default_agent&&J.default_agent!=e.get("agent_id"))return void this.newConversation(l,t,"",[],S&&SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,()=>this.sendMessage(t,s,n,o,r));this.openConversation(e.id),this.setConversation(e),R=!1}this.calculateLabelDateFirst(),-1==t&&(t=S?SB_ACTIVE_AGENT.id:a().id);let p=t!=_;if(s||n.length||(s=g.val().trim(),h.find(".sb-attachments > div").each(function(){n.push([e(this).attr("data-name"),e(this).attr("data-value")])}),S&&SBAdmin.must_translate&&(Q.dialogflow.translate([s],a().language,e=>{e.length&&(r?r["original-message"]=s:r={"original-message":s},e[0]&&(s=e[0])),this.sendMessage(t,s,n,o,r,l)}),d=!0)),this.busy(!0),p&&(g.val("").css("height",""),h.find(".sb-attachments").html("")),this.activateBar(!1),!d)if(!1===l&&t==_&&(l="skip"),S||!p||c||(l=2),s||n.length||r){let e={user_id:t,user:a(),conversation_id:this.conversation.id,conversation:this.conversation,conversation_status_code:l,attachments:n};F.ajax({function:"send-message",user_id:t,conversation_id:this.conversation.id,message:s,attachments:n,conversation_status_code:l,queue:!S&&M.queue&&p,payload:r,recipient_id:!!S&&a().id},i=>{let l=S||!c||i.human_takeover_active;S||t!=_||(this.dashboard?this.updateConversations():this.chat_open||this.updateNotifications("add",this.conversation.id)),(S&&!this.user_online||!S&&!this.agent_online)&&this.update(),S||!p||y||(this.followUp(),this.offlineMessage()),!S&&p&&(!r||"sb-human-takeover"!=r.id&&F.null(r["skip-dialogflow"]))&&Q.dialogflow.message(s,n),!S&&p&&"visitor"==a().type?F.ajax({function:"update-user-to-lead",user_id:t},()=>{a().set("user_type","lead"),M.slack_active&&l&&this.slackMessage(t,a().name,a().image,s,n)}):l&&!this.skip&&(S&&SB_ADMIN_SETTINGS.slack_active?this.slackMessage(a().id,SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image,s,n):M.slack_active&&this.slackMessage(a().id,p?a().name:M.bot_name,p?a().image:M.bot_image,s,n)),p&&M.language_detection&&this.conversation&&s.split(" ").length>1&&!F.storage("language-detection-completed")&&(F.ajax({function:"google-language-detection-update-user",user_id:t,string:s,token:Q.dialogflow.token},e=>{e&&(M.translations=e)}),F.storage("language-detection-completed",!0)),!this.articles||S||!M.articles||M.office_hours||this.isInitDashboard()||setTimeout(()=>{this.conversation&&(this.sendMessage(_,"[articles]"),this.scrollBottom(),this.articles=!1)},5e3),i.queue&&this.queue(this.conversation.id),e.message=i.message,e.message_id=i.id,F.event("SBMessageSent",e),A&&SBTickets.onMessageSent(),o&&o(e),i.notifications.length&&F.event("SBNotificationsSent",i.notifications),this.skip&&(this.skip=!1),this.busy(!1)}),p&&(s=F.escape(s),u.append(new V({id:"sending",profile_image:S?SB_ACTIVE_AGENT.profile_image:a().image,full_name:a().name,creation_time:"0000-00-00 00:00:00",message:s.replaceAll("<","&lt;"),user_type:S?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${i("Sending")}<i></i></div>`))),this.dashboard||!p&&!this.isBottom()||this.scrollBottom(),(this.audio&&!S&&this.chat_open&&p&&["a","aa"].includes(M.sound.code)||S&&"a"==SB_ADMIN_SETTINGS.sound.code)&&this.audio_out.play()}else this.busy(!1)},updateMessage:function(e,t=""){F.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t,s=!1,i=!1){let n=s?!0===s?a().id:s:this.getRecipientUserID();if(!S&&!isNaN(n)&&this.agent_online)return!1;F.ajax({function:"create-email",recipient_id:n,sender_name:S?s?SB_ACTIVE_AGENT.full_name:a().name:s?M.bot_name:a().name,sender_profile_image:S?s?SB_ACTIVE_AGENT.profile_image:a().name:s?M.bot_image:a().image,message:e,attachments:t,department:!!this.conversation&&this.conversation.get("department"),conversation_id:!!this.conversation&&this.conversation.id},e=>{i&&i(e)})},sendSMS:function(e){let t=this.getRecipientUserID();if(!S&&!isNaN(t)&&this.agent_online)return!1;F.ajax({function:"send-sms",to:t,message:e,conversation_id:!!this.conversation&&this.conversation.id},t=>{"sent"==t.status||"queued"==t.status?F.event("SBSMSSent",{recipient_id:this.getRecipientUserID(),message:e,response:t}):t.message&&F.error(t.message,"SBChat.sendSMS")})},desktopNotification:function(e,t,s,i=!1,n=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{W.sw.showNotification(e,{body:(new V).strip(t),icon:s.indexOf("user.svg")>0?M.notifications_icon:s}).onclick=(()=>{S?i?(SBAdmin.conversations.openConversation(i,0==n?a().id:n),SBAdmin.conversations.update()):n&&SBAdmin.profile.show(n):this.start(),window.focus()})}},getRecipientUserID:function(){return S?a().id:this.lastAgent(!1)?this.lastAgent(!1).user_id:F.null(this.conversation.get("agent_id"))?F.null(this.conversation.get("department"))?"agents":"department-"+this.conversation.get("department"):this.conversation.get("agent_id")},submit:function(){this.is_busy||(this.sendMessage(),M.cron_email_piping_active&&(setInterval(function(){F.ajax({function:"email-piping"})},6e4),M.cron_email_piping_active=!1),W.init_push_notifications&&W.initPushNotifications())},initChat:function(){S||F.getActiveUser(!0,()=>{let e=!1!==a(),t=!!e&&a().type;if(A||!M.popup||s("popup")||L&&M.popup_mobile_hidden||this.popup(),J.automations.runAll(),A||!M.privacy||M.registration_required||s("privacy-approved")){if(typeof Notification!==D&&!M.push_notifications_users&&(["all","users"].includes(M.desktop_notifications)||S&&"agents"==M.desktop_notifications)&&(this.desktop_notifications=!0),(["all","users"].includes(M.flash_notifications)||S&&"agents"==M.flash_notifications)&&(this.flash_notifications=!0),this.registration(!0)&&!A)return this.registration(),void(!e&&M.visitors_registration&&this.addUserAndLogin());e||!(typeof SB_WP_WAITING_LIST!==D||M.visitors_registration||M.welcome||M.subscribe||A)||A&&M.tickets_registration_required?!this.conversation&&e?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),this.subscribe(),Q.woocommerce.waitingList(),this.finalizeInit()}),M.header_name&&e&&"user"==t&&!A&&p.find(".sb-title").html(`${i("Hello")} ${a().nameBeautified}!`),this.welcome(),this.subscribe(),W.active||setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},10200),Q.woocommerce.waitingList(),this.scrollBottom(!0)}else this.privacy()})},finalizeInit:function(){this.initialized||(r.attr("style",""),S||A||(this.isInitDashboard()&&this.showDashboard(),!L&&window.innerHeight<760&&r.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,S||(a()&&!this.registration(!0)&&(s("open-conversation")&&this.openConversation(s("open-conversation")),F.getURL("conversation")&&this.openConversation(F.getURL("conversation"))),(!this.chat_open&&(!L&&s("chat-open")||"open"==F.getURL("chat"))||F.getURL("conversation"))&&setTimeout(()=>{this.start()},500),M.woocommerce_returning_visitor&&(!1===s("returning-visitor")?F.storageTime("returning-visitor"):F.storageTime("returning-visitor",24)&&!s("returning-visitor-processed")&&setTimeout(()=>{F.ajax({function:"woocommerce-returning-visitor"},()=>{s("returning-visitor-processed",!0)})},15e3)),M.timetable_type&&J.offlineMessage(),M.queue_human_takeover&&Q.dialogflow.humanTakeoverActive()&&(M.queue=!0)),A&&SBTickets.init(),F.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.chat_open=!0,this.popup(!0),this.conversation&&this.updateNotifications("remove",this.conversation.id),r.sbActive(!0),e("body").addClass("sb-chat-open"),"open"==M.welcome_trigger&&this.welcome(),Q.martfury.privateChat(),this.calculateLabelDates())},open:function(t=!0){t&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),r.sbActive(!0),e("body").addClass("sb-chat-open"),s("chat-open",!0),this.conversation&&s("last-open-message",this.conversation.getLastMessage().id),L&&history.pushState({"chat-open":!0},"",""),F.event("SBChatOpen")):!t&&this.chat_open&&(r.sbActive(!1),this.stopRealTime(),this.chat_open=!1,s("chat-open",!1),e("body").removeClass("sb-chat-open"),F.event("SBChatClose"))},openConversation:function(e){a().getFullConversation(e,t=>{if(!t.id||!J.isConversationAllowed(t.get("source")))return s("open-conversation",""),!1;this.setConversation(t),this.hideDashboard(),this.populate(),this.main_header=!1,s("queue")==e&&this.queue(e),(this.chat_open||A)&&this.updateNotifications("remove",e),A&&SBTickets.activateConversation(t),s("open-conversation",e),F.event("SBConversationOpen",t)})},update:function(){if(this.conversation){if(this.is_busy_update)return;let e=this.conversation.getLastMessage(),t=!1;F.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation,last_id:this.id_last_message_conversation},i=>{let a=i.length;if(this.is_busy_update=!1,this.conversation&&Array.isArray(i)&&a>0&&(!e||e.id!=i[a-1].id||e.message!=i[a-1].message||e.payload!=i[a-1].payload||e.attachments!=i[a-1].attachments)){let e="",o=[],r=[],l=!1;this.calculateLabelDateFirst();for(var n=0;n<a;n++)if(!r.includes(i[n].id)){let a=new V(i[n]),c=a.payload();if(this.id_last_message_conversation=a.id,this.datetime_last_message_conversation=a.get("creation_time"),!["boolean","string"].includes(typeof c)){if(c.event){let e=c.event;if(("delete-message"==e&&!1!==this.conversation.getMessage(a.id)||!S&&!a.message&&!a.attachments.length)&&this.deleteMessage(a.id),"woocommerce-update-cart"!=e||S||Q.woocommerce.updateCart(c.action,c.id),Q.dialogflow.active()||"conversation-status-update-3"!=e&&"conversation-status-update-4"!=e&&"activate-bot"!=e||(Q.dialogflow.active("activate"),l=!0),M.close_chat&&"conversation-status-update-3"==e)return void this.closeChat(!1)}c["human-takeover"]&&M.queue_human_takeover&&(M.queue=!0,J.queue(J.conversation.id))}this.conversation.getMessage(i[n].id)?(this.conversation.updateMessage(a.id,a),u.find(`[data-id="${a.id}"]`).replaceWith(a.getCode()),t=!0):((a.message||a.attachments.length)&&u.find('[data-id="sending"]').remove(),this.conversation.addMessages(a),e+=a.getCode(),t=!1),this.conversation.updateMessagesStatus(),o.push(a),r.push(a.id),this.chat_open&&s("last-open-message",a.id)}u.append(e);let c=this.conversation.getLastMessage(),d=!!c&&c.get("user_type"),h=F.isAgent(d);!S&&h&&"bot"!=d&&(this.chat_open&&(c&&-1==c.message.indexOf("sb-rich-success")&&this.setConversationStatus(0),M.follow&&clearTimeout(k)),l||Q.dialogflow.active(!1)),s("queue")==this.conversation.id&&h&&"bot"!=d&&this.queue("clear"),this.headerAgent(),this.dashboard||t||(this.scrollBottom(),setTimeout(()=>{this.scrollBottom()},300)),!this.dashboard&&this.chat_open||this.updateNotifications("add",this.conversation.id),this.typing(-1,"stop"),this.busy(!1),!this.audio||1==a&&F.null(o[0].message)&&F.null(o[0].attachments)||!(!S&&this.chat_open&&(h||"bot"==d)&&["aa","ia"].includes(M.sound.code)||S&&!F.isAgent(d)&&["a","i","ic"].includes(SB_ADMIN_SETTINGS.sound.code))||this.playSound(),F.event("SBNewMessagesReceived",o),A&&SBTickets.onNewMessageReceived(o[0])}}),this.is_busy_update=!0,setTimeout(()=>{this.is_busy_update=!1},5e3)}else this.updateConversations()},updateConversations:function(){a()&&F.ajax({function:"get-new-user-conversations",datetime:this.id_last_message},e=>{if(e.length){this.id_last_message=e[0].id,this.chat_open&&s("last-open-message",e[0].id);for(var t=0;t<e.length;t++){if(!J.isConversationAllowed(e[t].source))continue;let s=e[t].id,i=new V(e[t]),n=e[t].status_code,o=new H([i],{id:s,status_code:n,department:e[t].department,title:e[t].title}),r=a().addConversation(o);e[t].user_id==a().id||this.conversation.id==s&&this.chat_open||(this.updateNotifications("add",s),M.auto_open&&this.start());let l=i.payload();if("boolean"!=typeof l&&l.event){if("open-chat"==l.event&&(L?this.open(!1):((this.conversation.id!=s||this.dashboard)&&this.openConversation(s),setTimeout(()=>{this.open()},500))),!i.message&&!i.attachments.length)continue}this.tab_active||(this.desktop_notifications&&J.desktopNotification(i.get("full_name"),i.message,i.get("profile_image")),this.flash_notifications&&this.flashNotification(),!this.audio||!["a","aa","i"].includes(M.sound.code)||this.chat_open&&this.tab_active&&!this.dashboard||F.null(i.message)&&F.null(i.attachments)||this.playSound()),r&&(F.event("SBNewConversationReceived",o),A&&SBTickets.onNewConversationReceived(o))}this.conversation&&this.conversation.updateMessagesStatus(),r.find(".sb-user-conversations").html(a().getConversationsCode()),r.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",r.find(".sb-user-conversations > li").length>3)}})},populate:function(){if(this.conversation){let t="",a=u.find(" > .sb-notify-message"),n=!1,o=this.conversation.id;for(var e=0;e<this.conversation.messages.length;e++){let s=this.conversation.messages[e],a=F.beautifyTime(s.get("creation_time"));a.includes("today")&&(a=`<span>${i("Today")}</span>`),a!=n&&(s.message||s.attachments.length)&&(t+=`<div class="sb-label-date">${a}</div>`,n=a),t+=s.getCode()}if(u.html((a.length?a[0].outerHTML:"")+t),!this.dashboard&&(this.scrollBottom(),this.calculateLabelDates(),S&&SB_ADMIN_SETTINGS.notify_email_cron||!S&&M.notify_email_cron)){let e=this.conversation.getLastUserMessage(!1,!S);e&&e.id!=s("email-cron-"+o)&&(F.ajax({function:"remove-email-cron",conversation_id:o}),s("email-cron-"+o,e.id))}}else a()&&!a().isConversationsEmpty()&&(M.disable_dashboard?this.openConversation(a().conversations[0].id):this.showDashboard())},populateConversations:function(e=!1){!this.is_busy_populate&&a()&&(this.is_busy_populate=!0,setTimeout(()=>{this.is_busy_populate=!1},5e3),a().getConversations(t=>{let i=t.length;if(i){let e=Date.now(),o=t[0].messages[0];this.id_last_message=o.id;for(var n=0;n<i;n++)1!=t[n].status_code||s("last-open-message")==o.id||this.conversation&&this.conversation.id==t[n].id||this.updateNotifications("add",t[n].id),!L&&e-F.UTC(t[n].messages[0].get("creation_time"))<6e3&&this.open();r.find(".sb-user-conversations").html(a().getConversationsCode()),r.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",r.find(".sb-user-conversations > li").length>3)}r.setClass("sb-no-conversations",!i),this.initialized&&"open-conversation"!=R||1!=i||this.isInitDashboard()||s("open-conversation")||(this.openConversation(a().conversations[0].id),"open-conversation"==R&&(R="")),e&&e(t),this.finalizeInit()}))},newConversation:function(e,t=-1,s="",i=[],n=null,o=null,l=!1){a()?F.ajax({function:"new-conversation",status_code:e,title:A?r.find(".sb-ticket-title input").val():null,department:F.null(n)?this.default_department:n,agent_id:F.null(o)?this.default_agent:o,tags:this.default_tags,source:A?"tk":""},r=>{if(F.errorValidation(r,"user-not-found"))return void this.addUserAndLogin(()=>{this.newConversation(e,t,s,i,n,o,l)});let c=new H([],r.details);this.setConversation(c),(s||i.length)&&this.sendMessage(t,s,i),t!=_&&setTimeout(()=>{this.queue(c.id)},1e3),a().conversations.push(c),l&&l(c)}):F.error("activeUser() not setted","SBChat.newConversation")},setConversation:function(e){e instanceof H?(this.conversation=e,this.id_last_message_conversation=this.conversation.getLastMessage()?this.conversation.getLastMessage().id:0,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id),s("open-conversation",e.id),F.event("SBActiveConversationChanged",e)):F.error("Value not of type SBConversation","SBChat.setConversation")},queue:function(e){if("clear"==e)return r.removeClass("sb-notify-active sb-queue-active"),u.find(" > .sb-notify-message").remove(),clearInterval(this.queue_interval),this.queue_interval=!1,s("queue",""),void(M.queue_sound&&!J.tab_active&&J.playSound(999));!S&&M.queue&&F.ajax({function:"queue",conversation_id:e,department:this.conversation.get("department")},t=>{u.find(" > .sb-notify-message").remove();let a=t[0];if(0==a)this.queue("clear");else{let n=(M.queue_response_time?parseInt(M.queue_response_time):5)*a,o=i(M.queue_message?M.queue_message:"Please wait for an agent. You are number {position} in the queue. Your waiting time is approximately {minutes} minutes.").replace("{position}","<b>"+a+"</b>").replace("{minutes}","<b>"+n+"</b>");t[1]&&u.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${o}</div></div></div>`),!1===this.queue_interval&&(this.queue_interval=setInterval(()=>{this.queue(e)},10100),t[1]&&r.addClass("sb-notify-active sb-queue-active"),s("queue",e))}F.event("SBQueueUpdate",a)})},getDepartmentCode(e,t){if(this.departments)if("all"==e){let e="";for(var s in this.departments)this.getDepartmentCode(this.departments[s].id,t=>{e+=t});t(e)}else t(`<div data-color="${this.departments[e].color}">${this.departments[e].image?`<img loading="lazy" src="${this.departments[e].image}" />`:""}<div>${this.departments[e].name}<div></div>`);else F.ajax({function:"get-departments"},s=>{s&&(this.departments=s,this.getDepartmentCode(e,t))})},startRealTime:function(){W.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.typing(S?a()?a().id:-1:this.agent_id,"check")},1e3))},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){a()&&F.updateUsersActivity(a().id,this.agent_id,t=>{this.typing_settings.typing||("online"==t||this.agent_id==_?(e(f).addClass("sb-status-online").html(i("Online")),this.agent_online=this.agent_id!=_):(e(f).removeClass("sb-status-online").html(i("Away")),this.agent_online=!1))})},busy:function(e){h.find(".sb-loader").sbActive(e),this.is_busy=e,F.event("SBBusy",e)},headerAgent:function(){if(!S&&!A&&!this.dashboard&&this.conversation&&(-1==this.agent_id||this.conversation.getLastMessage()&&F.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let e=this.lastAgent();e&&(this.agent_id=e.user_id,this.headerReset(),p.addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img loading="lazy" src="${e.profile_image}" /><div><span class="sb-name">${e.full_name}</span><span class="sb-status">${i("Away")}</span></div><i class="sb-icon sb-icon-close ${M.close_chat?"sb-close-chat":"sb-responsive-close-btn"}"></i></div><div class="sb-label-date-top"></div>`),f=p.find(".sb-status"),this.updateUsersActivity(),b=p.find(".sb-label-date-top"),F.storageTime("header-animation",1)&&this.headerAnimation())}},headerReset:function(){0==this.start_header&&(this.start_header=[p.html(),p.attr("class")]),p.removeClass("sb-header-main sb-header-brand sb-header-agent sb-header-minimal"),this.main_header=!1},headerAnimation:function(){p.addClass("sb-header-animation"),setTimeout(()=>{p.removeClass("sb-header-animation")},8e3),F.storageTime("header-animation")},lastAgent:function(e=!0){let t=!1;if(this.conversation){let s=this.conversation.getLastUserMessage(!1,!e||"all");s&&(t={user_id:s.get("user_id"),full_name:s.get("full_name"),profile_image:s.get("profile_image")})}return t},scrollBottom:function(e=!1){E=!1,setTimeout(()=>{E=!0},1e3),setTimeout(()=>{v.scrollTop(e?0:v[0].scrollHeight),this.scrollHeader()},20)},isBottom:function(){return v[0].scrollTop===v[0].scrollHeight-v[0].offsetHeight},scrollHeader:function(){if(this.main_header&&this.dashboard){let e=v.scrollTop();e>-1&&e<1e3&&p.find(".sb-content").css({opacity:1-e/500,top:e/10*-1+"px"})}},showDashboard:function(){S||A||(r.addClass("sb-dashboard-active"),p.removeClass("sb-header-agent"),this.hidePanel(),this.start_header&&p.html(this.start_header[0]).addClass(this.start_header[1]),v.find(" > div").sbActive(!1),r.find(".sb-dashboard").sbActive(!0),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),F.event("SBDashboard"))},hideDashboard:function(){S||A||(u.sbActive(!0),r.removeClass("sb-dashboard-active").find(".sb-dashboard").sbActive(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),F.event("SBDashboardClosed"))},showPanel:function(e,t){if(A)return SBTickets.showPanel(e,t);let s=v.find(" > .sb-panel-"+e);s.length&&(v.find(" > div").sbActive(!1),s.sbActive(!0),this.start_header||(this.start_header=[p.html(),p.attr("class")]),p.attr("class","sb-header sb-header-panel").html(`${i(t)}<div class="sb-dashboard-btn sb-icon-close"></div>`),r.addClass("sb-panel-active"),this.dashboard=!0),F.event("SBPanelActive",e)},hidePanel:function(){r.removeClass("sb-panel-active"),p.removeClass("sb-header-panel")},clear:function(){this.conversation=!1,u.html("")},updateNotifications:function(e="add",t){if("add"!=e||this.notifications.includes(t)||(this.notifications.push(t),!this.dashboard&&this.conversation&&this.conversation.id!=t&&this.headerAnimation()),"remove"==e)for(var s=0;s<this.notifications.length;s++)if(this.notifications[s]==t){this.notifications.splice(s,1),0!=this.conversation.status_code&&["1","2",1,2].includes(this.conversation.status_code)&&this.setConversationStatus(0);break}let i=this.notifications.length;r.find(".sb-chat-btn span").attr("data-count",i).html(i>-1?i:0),F.event("SBNotificationsUpdate",{action:e,conversation_id:t})},setConversationStatus:function(e){return!!this.conversation&&(F.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},()=>{this.conversation.set("status_code",e),F.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})}),!0)},typing:function(t=-1,s="check"){if(this.conversation){let n=this.agent_online||S&&this.user_online;if("check"==s&&!W.active&&-1!=t&&t!=_&&n)F.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")});else if("set"==s&&n){let e=this.conversation.get("source");clearTimeout(C),e&&(e="fb"==e?[e,a().getExtra("facebook-id").value,this.conversation.get("extra")]:"tw"==e&&[e,a().getExtra("twitter-id").value]),W.active?F.debounce(()=>{W.trigger("client-typing",{user_id:S?SB_ACTIVE_AGENT.id:a().id,conversation_id:this.conversation.id}),e&&F.ajax({function:"set-typing",source:e})},"#2"):this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{F.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,F.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id,source:e}),this.typing(t,"set"))}else if("start"==s||"stop"==s){let t="start"==s;if(!S&&f)if(t)e(f).addClass("sb-status-typing").html(i("Typing"));else{let t=this.agent_online||this.agent_id==_;e(f).removeClass("sb-status-typing").html(i(t?"Online":"Away")),t&&e(f).addClass("sb-status-online")}this.typing_settings.typing=t,F.event("SBTyping",t)}}},showArticles:function(e=-1){let t=A?r.find(".sb-panel-main .sb-panel"):v.find(" > .sb-panel-articles"),s="";t.html("").sbLoading(!0),this.showPanel("articles",M.articles_title?M.articles_title:"Help Center"),this.getArticles(e,a=>{if(-1==e&&this.articles_categories){let e=[];for(var n=0;n<this.articles_categories.length;n++){let t=this.articles_categories[n],r="";for(o=0;o<a.length;o++){let s=a[o];e.includes(s.id)||t&&!F.null(s.parent_category)&&!s.parent_category.includes(t.id)||(r+=`<div data-id="${s.id}"><div>${s.title}</div><span>${s.content}</span></div>`,e.push(s.id))}r&&(s+=(t?`<div data-id="${t.id}" class="sb-title">${i(t.title)}</div>`:"")+r)}t.html(`<div class="sb-articles">${s}</div>`)}else if(a)if(a.content)t.html(this.getArticleCode(a));else{for(var o=0;o<a.length;o++)s+=`<div data-id="${a[o].id}"><div>${a[o].title}</div><span>${a[o].content}</span></div>`;t.html(`<div class="sb-articles">${s}</div>`)}t.sbLoading(!1),F.event("SBArticles",{id:e,articles:a})})},getArticles:function(e=!1,t=!1,s=!0,i=!1){let a=-1==e||!1===e;if(!1===this.articles||-1!=e)F.ajax({function:"get-articles",categories:this.articles_category?this.articles_category:s,articles_language:typeof SB_LANG!=D&&SB_LANG[0],id:a?this.articles_allowed_ids:e,count:i,return_categories:!!this.articles_category,full:!a},e=>{let s=!(!e[0]||!e[0].content);a&&(this.articles=s?e:e[0],s||(this.articles_categories=e[1].length?e[1]:[""])),t(a&&!s?e[0]:e)});else{if(!t)return this.articles;if(s&&!0!==s&&"true"!=s){let e=[];for(var n=0;n<this.articles.length;n++)(this.articles[n].categories&&this.articles[n].categories.includes(s)||this.articles[n].parent_category&&s==this.articles[n].parent_category)&&e.push(this.articles[n]);t(e)}else t(this.articles)}},searchArticles:function(t,s,a){t&&(e(s).sbLoading(!0),F.ajax({function:"search-articles",articles_language:typeof SB_LANG!=D&&SB_LANG[0],search:t},t=>{let n="";if(0==t.length)n+=`<p class="sb-no-results">${i("No articles found.")}</p>`;else for(var o=0;o<t.length;o++)n+=`<div data-id="${t[o].id}"><div>${t[o].title}</div><span>${t[o].content}</span></div>`;e(a).html(n),e(s).sbLoading(!1)}))},setArticleRating:function(e,t,s=!1){F.ajax({function:"article-ratings",article_id:e,rating:t},e=>{s&&s(e)})},articleRatingOnClick:function(t){let s=e(t).closest(".sb-article");if(!s[0].hasAttribute("data-user-rating")){e(t).parent().sbLoading();let i="positive"==e(t).attr("data-rating")?1:-1,a=e(t).closest(".sb-article").attr("data-id");J.setArticleRating(a,i,()=>{F.storage("article-rating-"+a,i),s.attr("data-user-rating",i),e(t).parent().sbLoading(!1)})}},getArticleCode:function(e){let t=F.storage("article-rating-"+e.id),s="";if(this.articles_categories&&!F.null(e.categories))for(var a=0;a<this.articles_categories.length;a++){let t=this.articles_categories[a].id;(e.categories.includes(t)||e.parent_category==t)&&(s+=`<span data-id="${t}">${i(this.articles_categories[a].title)}</span>`)}return`<div data-id="${e.id}"${t?` data-user-rating="${t}"`:""} class="sb-article"><div class="sb-title">${e.title}<div class="sb-close sb-icon-close"></div></div><div class="sb-content">${e.content.replace(/(?:\r\n|\r|\n)/g,"<br>")}</div>${F.null(e.link)?"":`<a href="${e.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${i("Read more")}</a>`}${s?`<div class="sb-article-category-links">${s}</div>`:""}<div class="sb-rating"><span>${i("Rate and review")}</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${i("Helpful")}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${i("Not helpful")}</span></i></div></div></div>`},initArticlesPage:function(){let s,a,n="",o="",r={},l={};(G=e("body").find("#sb-articles")).length||(G=e("body")),G.sbLoading(!0),this.getArticles(-1,()=>{for(s=0;s<this.articles.length;s++){let t=this.articles[s];if(n+=`<div data-id="${t.id}"><div>${t.title}</div><span>${t.content}</span></div>`,!F.null(t.parent_category)&&(t.parent_category in r||(r[t.parent_category]=[]),!F.null(t.categories)))for(var e=0;e<t.categories.length;e++)r[t.parent_category].includes(t.categories[e])||r[t.parent_category].push(t.categories[e])}for(s=0;s<this.articles_categories.length;s++)l[this.articles_categories[s].id]=this.articles_categories[s].title;for(var t in r){o+=`<div class="sb-parent-category"><span data-id="${t}">${i(l[t])}</span><div class="sb-ul">`;for(var s=0;s<r[t].length;s++)o+=`<span data-id="${r[t][s]}">${i(l[r[t][s]])}</span>`;o+="</div></div>"}G.html(`<div class="sb-articles-page${M.rtl?" sb-rtl":""}"><div class="sb-panel-main sb-articles">${n}</div><div class="sb-panel-side"><div class="sb-title">${M.articles_title?M.articles_title:"Help Center"}</div><div class="sb-input sb-input-btn"><input placeholder="${i("Search for articles...")}" autocomplete="off"><div class="sb-submit-articles sb-icon-arrow-right"></div></div><div class="sb-title">${i("Categories")}</div><div class="sb-article-categories"><div><span data-id="true" class="sb-active">${i("All articles")}</span></div>${o}</div></div></div>`),G.sbLoading(!1),a=G.find(".sb-panel-main"),F.getURL("article")&&G.find(`.sb-articles > [data-id="${F.getURL("article")}"]`).click(),F.getURL("category")&&G.find(`.sb-article-categories [data-id="${F.getURL("category")}"]`).click()}),G.on("keydown",".sb-panel-side input",function(t){13==t.which&&e(this).next().click()}),G.on("click",".sb-articles > [data-id]",function(){s=a.html(),a.sbLoading(!0),J.getArticles(e(this).attr("data-id"),e=>{a.removeClass("sb-articles").html(J.getArticleCode(e)),a.sbLoading(!1)})}),G.on("click",".sb-article [data-rating]",function(){J.articleRatingOnClick(this)}),G.on("click",".sb-article .sb-title .sb-close",function(){G.find(".sb-panel-main").addClass("sb-articles").html(s)}),G.on("click",".sb-submit-articles",function(){let t=e(this).parent().find("input").val();t?(s=a.html(),a.html(""),J.searchArticles(t,this,a)):a.html(s),a.addClass("sb-articles")}),G.on("click",".sb-article-categories [data-id]",function(){if(t(a))return;let n="";s=a.html(),G.find(".sb-article-categories [data-id]").sbActive(!1),e(this).sbActive(!0),J.getArticles(-1,e=>{for(var t=0;t<e.length;t++)n+=`<div data-id="${e[t].id}"><div>${e[t].title}</div><span>${e[t].content}</span></div>`;a.addClass("sb-articles").html(n||`<p class="sb-no-results">${i("No articles found.")}</p>`),a.sbLoading(!1)},e(this).attr("data-id"))})},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var s=0;s<t.length;s++)t[s].category.startsWith(e)&&this.emoji_options.list_now.push(t[s])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let t=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return typeof t==D&&(t=e.originalEvent.deltaY),typeof t==D&&(t=-1*e.originalEvent.detail),t})(e)>0||L&&typeof e.originalEvent.changedTouches!==D&&this.emoji_options.touch<e.originalEvent.changedTouches[0].clientY?t-=t<1?0:1:t+=t>this.emoji_options.range_limit?0:1,m.find(".sb-emoji-bar > div").sbActive(!1).eq(t).sbActive(!0),this.emoji_options.range=t,this.populateEmoji(t),e.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),m.sbTogglePopup()},showEmoji:function(e){m.sbTogglePopup(e)&&(S||m.css({left:h.offset().left+(A?68:20),top:h.offset().top-window.scrollY-(A?h.height()-330:304)}),m.find(".sb-emoji-list > ul").html()||jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji"}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),F.deselectAll())},populateEmoji:function(e){let t="",s=L?42:48,i=e*s+s,a=this.emoji_options.list_now;i>a.length&&(i=a.length),this.emoji_options.range_limit=a.length/s-1,this.emoji_options.range=e;for(var n=e*s;n<i;n++)t+=`<li>${a[n].char}</li>`;m.find(".sb-emoji-list").html(`<ul>${t}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>',t=L?42:49;for(var s=0;s<this.emoji_options.list_now.length/t-1;s++)e+="<div></div>";this.emoji_options.range=0,m.find(".sb-emoji-bar").html(e)},clickEmojiBar:function(t){let s=e(t).index();this.populateEmoji(s),this.emoji_options.range=s,m.find(".sb-emoji-bar > div").sbActive(!1).eq(s).sbActive(!0)},searchEmoji:function(e){F.search(e,()=>{if(e.length>1){let s=this.emoji_options.list,i=[];for(var t=0;t<s.length;t++)(s[t].category.toLowerCase().includes(e)||s[t].name.toLowerCase().includes(e))&&i.push(s[t]);this.emoji_options.list_now=i}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},textareaChange:function(t){let s=e(t).val();S&&(SBAdmin.conversations.savedReplies(t,s),SBAdmin.apps.openAI.rewriteButton(s)),s?(this.typing(S&&!W.active?SB_ACTIVE_AGENT.id:a().id,"set"),this.activateBar()):this.activateBar(!1)},insertText:function(t){let s=e(g.get(0)),i=0;if(this.dashboard)return!1;if(s.get(0).selectionStart)i=s.get(0).selectionStart;else if(document.selection){s.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-s.value.length),i=e.text.length-a}s.val(s.val().substr(0,i)+t+s.val().substr(i)),s.focus(),s.manualExpandTextarea(),this.activateBar()},enabledAutoExpand:function(){g.length&&g.autoExpandTextarea()},privacy:function(){F.ajax({function:"get-block-setting",value:"privacy"},e=>{v.append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message.replace(/\n/g,"<br>")}</div>`+(e.link?`<a target="_blank" href="${e.link}">${e["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit(),F.event("SBPrivacy")}),this.dashboard||this.showDashboard(),this.dashboard=!0,r.addClass("sb-init-form-active")},popup:function(e=!1,t=!1){if(e){let e=r.find(".sb-popup-message"),t=e.attr("data-id");return s("popup"+(F.null(t)?"":t),!0),void e.remove()}setTimeout(()=>{this.chat_open||(0==t&&(t=M.popup),r.find(".sb-popup-message").remove(),r.append(`<div data-id="${t.id?t.id:""}" class="sb-popup-message">`+(t.image?`<img loading="lazy" src="${t.image}" />`:"")+(t.title?`<div class="sb-top">${t.title}</div>`:"")+`<div class="sb-text">${t.message}</div><div class="sb-icon-close"></div></div>`),F.event("SBPopup",t))},1e3)},followUp:function(){this.followUpCheck()&&(k&&clearTimeout(k),k=setTimeout(()=>{this.followUpCheck()&&(F.ajax({function:"execute-bot-message",conversation_id:this.conversation.id,name:"follow_up",check:!1}),F.storageTime("email"),F.event("SBFollowUp"))},!0===M.follow?M.office_hours||N?15e3:5e3:parseInt(M.follow)))},followUpCheck:function(){return!S&&this.conversation&&M.follow&&a()&&!a().email&&F.storageTime("email",24)},welcome:function(){A||"open"==M.welcome_trigger&&!this.chat_open||!M.office_hours&&M.welcome_disable_office_hours||!M.welcome||s("welcome")||!a()||F.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{M.dialogflow_welcome?!1===this.conversation?this.newConversation(3,-1,"",[],null,null,function(){Q.dialogflow.welcome(e.open,e.sound)}):Q.dialogflow.welcome(e.open,e.sound):(this.sendMessage(_,e.message,[],!1,!1,3),e.open&&this.start(),e.sound&&this.audio.play()),this.skip=!0,F.event("SBWelcomeMessage")},parseInt(A?0:M.welcome_delay)),s("welcome",!0)})},subscribe:function(){M.subscribe&&!s("subscribe")&&a()&&F.null(a().email)&&a()&&setTimeout(()=>{this.conversation.id&&F.ajax({function:"execute-bot-message",conversation_id:this.conversation.id,name:"subscribe",check:!1},e=>{e.settings.sound&&this.audio&&this.audio.play(),this.skip=!0,s("subscribe",!0)})},parseInt(M.subscribe_delay))},offlineMessage:function(){if(!S&&M.timetable&&(!M.office_hours||!N&&!M.timetable_disable_agents)){let e=M.timetable_message;switch(M.timetable_type){case"header":this.offline_message_set||(e[0]&&p.find(".sb-title").html(e[0]),p.find(".sb-text").html(e[1]),this.offline_message_set=!0);break;case"info":this.offline_message_set||(u.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${e[0]?`<b>${e[0]}</b> `:""}${e[1]}</div></div></div>`),r.addClass("sb-notify-active"),this.offline_message_set=!0);break;default:setTimeout(()=>{if(this.conversation){let t=M.timetable_hide?`${e[0]?`*${e[0]}*\n`:""}${e[1]}`:"[timetable]",s=this.conversation.searchMessages(t,!0);if(s=!!s.length&&s){let e=this.conversation.getLastUserMessage(!1,!0);s=!e||e.get("index")<s[s.length-1].get("index")}s||this.sendMessage(_,t)}},5e3)}}},slackMessage:function(e,t,s,i,n=[]){if(!this.conversation||!i&&!n.length)return!1;let o=this.conversation.id;F.ajax({function:"send-slack-message",user_id:e,full_name:t,profile_image:s,conversation_id:o,message:i,attachments:n,channel:this.slack_channel[0]==a().id&&this.slack_channel[1]},e=>{this.slack_channel=[a().id,e[1]],F.event("SBSlackMessageSent",{message:i,conversation_id:o,slack_channel:e[1]})})},deleteMessage:function(e){F.ajax({function:"delete-message",message_id:e},()=>{this.conversation&&this.conversation.deleteMessage(e),u.find(`[data-id="${e}"]`).remove(),F.event("SBMessageDeleted",e)})},registration:function(e=!1,t=M.registration_required){if(e)return M.registration_required&&(!M.registration_offline||!N)&&(!M.registration_timetable||!M.office_hours)&&(!1===a()||["visitor","lead"].includes(a().type));v.append(X.generate({},M.registration_link?"login":t,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),r.addClass("sb-init-form-active")},activateBar:function(e=!0){h.find(".sb-bar").sbActive(e)},addUserAndLogin:function(e=!1,t=!1){let s=typeof SB_DEFAULT_USER!=D&&SB_DEFAULT_USER?SB_DEFAULT_USER:{};s.user_type=t?"lead":"visitor",F.ajax({function:"add-user-and-login",settings:s,settings_extra:s.extra},t=>{F.loginCookie(t[1]),a(new z(t[0])),W.start(),W.active||J.automations.runAll(),e&&e(t)})},isInitDashboard:function(){return M.init_dashboard||a()&&a().conversations.length>1},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){let e="The file you are trying to upload has an extension that is not allowed.";S?SBAdmin.dialog(e,"info"):alert(e)}else if(e(c).hasClass("sb-input-image"))e(c).find(".image").attr("data-value","").css("background-image",""),setTimeout(()=>{e(c).find(".image").attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${F.random()}")`).append('<i class="sb-icon-close"></i>'),c=!1},500);else{let e=t[1].substr(t[1].lastIndexOf("/")+1);h.find(".sb-attachments").append(`<div data-name="${e}" data-value="${t[1]}">${e}<i class="sb-icon-close"></i></div>`),J.activateBar()}else F.error(t[1],"sb-upload-files.change");this.busy(!1)},closeChat:function(e=!0){function t(){r.find(`li[data-conversation-id="${i}"]`).remove(),R="new-conversation",J.clear(),s("open-conversation",""),s("welcome",""),a().removeConversation(i),M.disable_dashboard||J.showDashboard()}let i=this.conversation.id;J.clear(),e?F.ajax({function:"update-conversation-status",conversation_id:i,status_code:3},()=>{t()}):t()},automations:{history:[],busy:[],scroll_position_intervals:{},timeout_queue:[],runAll:function(){let t=M.automations;for(var s=0;s<t.length;s++){let o=t[s],r=o.conditions,l=0==r.length,c=!1,d=!1,u=!1;for(var i=0;i<r.length;i++){let t=r[i][1];switch(l=!1,r[i][0]){case"browsing_time":l=!0,c=t;break;case"scroll_position":l=!0,d=t;break;case"include_urls":case"exclude_urls":case"referring":let s="referring"==r[i][0]?document.referrer:window.location.href,o=r[i][2].split(","),h="exclude_urls"!=r[i][0];h||(l=!0),s=s.replace("https://","").replace("http://","").replace("www.","");for(var n=0;n<o.length;n++)if(o[n]=e.trim(o[n].replace("https://","").replace("http://","").replace("www.","")),"contains"==t&&-1!=s.indexOf(o[n])||"does-not-contain"==t&&-1==s.indexOf(o[n])||"is-exactly"==t&&o[n]==s||"is-not"==t&&o[n]!=s){l=h;break}break;case"custom_variable":let g=t.split("=");g[0]in window&&window[g[0]]==g[1]&&(l=!0);break;case"returning_visitor":case"user_type":case"cities":case"languages":case"countries":l=a(),u=!0;break;case"user_phone":l=a()&&!F.null(a().getExtra("phone"));break;case"user_email":l=a()&&!F.null(a().email);break;default:l=!0}if(!l)break}["messages","emails","sms"].includes(o.type)&&!a()&&(l=!1),l&&(u?o.id in this.busy||(F.ajax({function:"automations-validate",automation:o},e=>{!1!==e&&this.runAll_final(o,d,c),delete this.busy[o.id]}),this.busy[o.id]=!0):this.runAll_final(o,d,c))}},runAll_final:function(t,s,i){s?this.scroll_position_intervals[t.id]=setInterval(()=>{e(window).scrollTop()>parseInt(s)&&(i?setTimeout(()=>{this.run(t)},1e3*parseInt(i)):this.run(t),clearInterval(this.scroll_position_intervals[t.id]))},1e3):i?this.timeout_queue.includes(t.id)||(setTimeout(()=>{this.run(t)},1e3*parseInt(i)),this.timeout_queue.push(t.id)):this.run(t)},run:function(e){if(!this.history.includes(e.id))switch(e.type){case"messages":case"emails":case"sms":if((!W.active||W.started)&&!(e.id in this.busy)){if("messages"==e.type&&J.chat_open){let e=!!J.conversation&&J.conversation.getLastUserMessage(!1,"no-bot");if(e&&Date.now()-6e5<F.unix(e.get("creation_time")))return}F.ajax({function:"automations-run",automation:e},t=>{!1!==t&&(this.history.push(e.id),"messages"!=e.type||W.active||J.updateConversations()),delete this.busy[e.id]}),this.busy[e.id]=!0}break;case"popups":s("popup"+e.id)||setTimeout(()=>{if(J.chat_open){if(e.fallback){let t=!!J.conversation&&J.conversation.getLastUserMessage(!1,"no-bot");(!t||Date.now()-6e5>F.unix(t.get("creation_time")))&&(J.sendMessage(_,(F.null(e.title)?"":`*${e.title}*\n`)+e.message,[],!1,!1,0),s("popup"+e.id,!0),this.history.push(e.id))}}else J.popup(!1,{id:e.id,image:e.profile_image,title:e.title,message:e.message}),this.history.push(e.id)},1e3);break;case"design":e.background&&p.css("background-image",`url("${e.background}")`),e.brand&&p.find(".sb-brand img").attr("src",e.brand),e.title&&p.find(".sb-title").html(e.title),e.message&&p.find(".sb-text").html(e.message),e.icon&&r.find(".sb-chat-btn .sb-icon").attr("src",e.icon),(e.color_1||e.color_2||e.color_3)&&F.ajax({function:"chat-css",color_1:e.color_1,color_2:e.color_2,color_3:e.color_3},e=>{l.append(`<style>${e}</style>`)}),this.history.push(e.id);break;case"more":let t={};if(e.department&&(J.default_department=e.department,t={function:"update-conversation-department",department:e.department}),e.agent&&(J.default_agent=e.agent,t={function:"update-conversation-agent",agent_id:e.agent}),e.tags&&(e.tags=e.tags.split(","),J.default_tags=e.tags,t={function:"update-tags",tags:e.tags,add:!0}),J.conversation.id&&(e.tags||e.agent||e.department)&&(t.conversation_id=J.conversation.id,F.ajax(t)),e.articles||e.articles_category){let t=r.find(".sb-dashboard-articles > .sb-articles");J.articles_allowed_ids=e.articles,J.articles_category=e.articles_category,t&&J.getArticles(e.articles,e=>{let s="";for(var i=0;i<2;i++)s+=`<div data-id="${e[i].id}"><div>${e[i].title}</div><span>${e[i].content}</span></div>`;t.html(s)},e.articles_category,2)}this.history.push(e.id)}}},flashNotification:function(){clearInterval($),$=setInterval(function(){document.title=document.title==j?i("New message..."):j},2e3)},calculateLabelDates:function(){(S||this.chat_open)&&(x=u.find(".sb-label-date"))},calculateLabelDateFirst:function(){this.conversation.messages.length||u.append(`<div class="sb-label-date"><span>${i("Today")}</span></div>`)},playSound:function(e=!1){this.audio.play();let t=e||(S?SB_ADMIN_SETTINGS.sound.repeat:M.sound.repeat);t&&(clearInterval(this.audio_interval),this.audio_interval=setInterval(()=>{this.audio.play(),--t||clearInterval(this.audio_interval)},1e3*this.audio.duration+1500))},isConversationAllowed:function(e){return!M.tickets_hide||A&&"tk"==e||!A&&"tk"!=e}};window.SBChat=J;var X={rich_messsages:{email:"",button:"",video:"",image:"","woocommerce-button":"",chips:'<div class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',rating:'<div class="sb-rating" data-success-negative="[success-negative]"><span>[label]</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>[positive]</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>[negative]</span></i></div></div>',card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',phone:""},cache:{},generate:function(t,s,n=""){let o,l=!0,c=t.id?t.id:F.random(),d=new V({});if(s in this.rich_messsages)o=this.rich_messsages[s];else if(s in this.cache)o=this.cache[s];else{if(!(S&&SB_ADMIN_SETTINGS.rich_messages.includes(s)||!S&&M.rich_messages.includes(s)))return!1;t.id||(c=s),o='<div class="sb-rich-loading sb-loading"></div>',F.ajax({function:"get-rich-message",name:s,settings:t},e=>{e=d.render(this.initInputs(e)),"timetable"==s&&(e=this.timetable(e)),r.find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${e}</div>`),this.cache[s]=e,J.scrollBottom(J.dashboard),F.event("SBRichMessageShown",{name:s,settings:t,response:e})}),l=!1}let u=t.disabled;if(l){let n,r="";switch(s){case"rating":o=o.replace("[label]",i(t.label?t.label:"Rate and review")).replace("[success-negative]",i(F.null(t["success-negative"])?"Not helpful":t["success-negative"])).replace("[positive]",i(F.null(t["label-positive"])?"Helpful":t["label-positive"])).replace("[negative]",i(F.null(t["label-negative"])?"Not helpful":t["label-negative"]));break;case"email":let l=[],c=a().email,d="#"==a().get("last_name").charAt(0);"true"==t.name&&l.push(["first_name","true"==t["last-name"]?"First name":"Name",d?"":"true"==t["last-name"]?a().get("first_name"):a().name,"text",!0]),"true"==t["last-name"]&&l.push(["last_name","Last name",d?"":a().get("last_name"),"text",!0]);for(h=0;h<l.length;h++)o+=`<div id="${l[h][0]}" data-type="text" class="sb-input sb-input-text"><span class="${l[h][2]?"sb-active sb-filled":""}">${i(l[h][1])}</span><input value="${l[h][2]}" autocomplete="false" type="${l[h][3]}" ${l[h][4]?"required":""}></div>`;if("true"==t.phone){let e=a().getExtra("phone"),s=S?[]:M.phone_codes,n="";if(1===s.length)n=`<input disabled value="${s[0]}">`;else{for(h=0;h<s.length;h++)n+=`<option value="+${s[h]}">+${s[h]}</option>`;n=`<select><option value="">+00</option>${n}</select>`}o+=`<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${e?"sb-active sb-filled":""}">${i("Phone")}</span><div>${n}</div><input value="${S?"":e}" pattern="[0-9]+" autocomplete="false" type="tel" ${"false"!=t["phone-required"]?"required":""}></div>`}o+=`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${c?"sb-active sb-filled":""}">${i(F.null(t.placeholder)?"Email":t.placeholder)}</span><input value="${c}" autocomplete="off" type="email" required><div class="sb-submit sb-icon-arrow-right"></div></div>`;break;case"image":o=`<div class="sb-image"><img loading="lazy" src="${t.url}"></div>`;break;case"video":o=`<iframe loading="lazy"${t.height?` height="${t.height}"`:""} src="${"youtube"==t.type?"//www.youtube.com/embed/":"//player.vimeo.com/video/"}${t.id}" allowfullscreen></iframe>`;break;case"select":n=t.options.replace(/\\,/g,"{R}").split(",");for(h=0;h<n.length;h++){let e=n[h].replace(/{R}/g,",");r+=`<li data-value="${F.stringToSlug(e)}">${i(e)}</li>`}o=o.replace("[options]",r);break;case"chips":case"buttons":n=t.options.replace(/\\,/g,"{R}").split(",");for(h=0;h<n.length;h++)r+=`<div class="sb-btn sb-submit">${i(n[h].replace(/{R}/g,","))}</div>`;o=o.replace("[options]",r);break;case"button":let g=t.link.includes("calendly.com");o=`<a ${g?'data-action="calendly" data-extra="'+t.link+"|"+(t.success?t.success.replaceAll('"',"'"):"")+'" ':""}href="${g?"#":t.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${t.target&&!g?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==t.style?"-text":""}">${i(t.name)}</a>`;break;case"list":if(t.values){n=t.values.replace(/\\,/g,"{R}").split(",");let a="list"==s,l=a&&n.length&&n[0].indexOf(":")>0;a&&!l&&(o=o.replace("sb-text-list","sb-text-list sb-text-list-single"));for(h=0;h<n.length;h++){let t=n[h].replace(/{R}/g,",");r+=l?`<div><div>${i(t.split(":")[0])}</div><div>${i(t.split(":")[1])}</div></div>`:`<div>${e.trim(i(t))}</div>`}o=o.replace("[values]",r)}break;case"list-image":if(t.values){n=t.values.split(",");for(h=0;h<n.length;h++){let e=n[h].replace("://","///").split(":");r+=`<div><div class="sb-thumb" style="background-image:url('${e[0].replace("///","://")}')"></div><div class="sb-list-title">${e[1]}</div><div>${e[2]}</div></div>`}o=o.replace("[values]",r)}break;case"table":if(t.values){n=t.header.split(","),r+="<tr>";for(h=0;h<n.length;h++)r+=`<th>${n[h]}</th>`;r+="</tr>",o=o.replace("[header]",r),r="",n=t.values.split(",");for(h=0;h<n.length;h++){let e=n[h].split(":");r+="<tr>";for(h=0;h<e.length;h++)r+=`<td>${e[h]}</td>`;r+="</tr>"}o=o.replace("[values]",r)}break;case"inputs":if(t.values){n=t.values.split(",");for(h=0;h<n.length;h++)u&&!n[h]||(r+=`<div id="${F.stringToSlug(n[h])}" data-type="text" class="sb-input sb-input-text"><span>${i(n[h])}</span><input autocomplete="false" type="text" required></div>`);r+='<div class="sb-btn sb-submit">'+i(t.button?t.button:"Send now")+"</div>",o=o.replace("[values]",r)}break;case"card":r=`${t.image?`<div class="sb-card-img" style="background-image:url('${t.image}')"></div>`:""}<div class="sb-card-header">${t.header}</div>${t.extra?`<div class="sb-card-extra">${t.extra}</div>`:""}${t.description?`<div class="sb-card-description">${t.description}</div>`:""}${t.link?`<a class="sb-card-btn" href="${t.link}"${t.target?' target="_blank"':""}>${i(t["link-text"])}</a>`:""}`,o=o.replace("[settings]",r);break;case"share":let p=t.channels?t.channels.replace(/ /g,"").split(","):["fb","tw","li","wa","pi"],f="";for(h=0;h<p.length;h++){switch(p[h]){case"fb":f="www.facebook.com/sharer.php?u=";break;case"tw":f="twitter.com/intent/tweet?url=";break;case"li":f="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":f="web.whatsapp.com/send?text=";break;case"pi":f="www.pinterest.com/pin/create/button/?url="}r+=`<div class="sb-${p[h]} sb-icon-social-${p[h]}" data-link="https://${f}${t.link}"></div>`}o=o.replace("[settings]",r);break;case"slider":let m=0;for(h=1;h<16&&"header-"+h in t;h++)r+=`<div>${"image-"+h in t?`<div class="sb-card-img" style="background-image:url('${t["image-"+h]}')"></div>`:""}<div class="sb-card-header">${t["header-"+h]}</div>${"extra-"+h in t?`<div class="sb-card-extra">${t["extra-"+h]}</div>`:""}${"description-"+h in t?`<div class="sb-card-description">${t["description-"+h]}</div>`:""}${"link-"+h in t?`<a class="sb-card-btn" href="${t["link-"+h]}"${t.target?' target="_blank"':""}>${i(t["link-text-"+h])}</a>`:""}</div>`,m++;o=o.replace("[items]",r).replace(/\[class\]/g,1==m?" sb-hide":"");break;case"slider-images":if(t.images){let e=t.images.split(",");for(var h=0;h<e.length;h++)r+=`<div class="sb-card-img" data-value="${e[h]}" style="background-image:url('${e[h]}')"></div>`;o=o.replace(/\[class\]/g,1==e.length?" sb-hide":"")}o=o.replace("[items]",r);break;case"woocommerce-button":t.settings=`checkout:${t.checkout},coupon:${t.coupon}`,o=`<a href="#" data-ids="${t.ids}" class="sb-rich-btn sb-btn">${t.name}</a>`}}return`<div id="${c}" data-type="${s}"${u?'disabled="true"':""}${t.settings?` data-settings="${t.settings}"`:""}class="sb-rich-message sb-rich-${s} ${n}">`+(t.title?`<div class="sb-top">${d.render(i(t.title))}</div>`:"")+(t.message?`<div class="sb-text">${d.render(i(t.message))}</div>`:"")+`<div class="sb-content">${o}</div><div data-success="${t.success?t.success.replace(/"/g,""):""}" class="sb-info"></div></div>`},submit:function(s,n,o){if(!S&&!t(o)&&!this.is_busy){let t="",c="",d={},u=e(s).find("[data-success]").length?e(s).find("[data-success]").attr("data-success"):"",h=e(s).closest(".sb-rich-message").attr("id"),g=e(s).closest("[data-id]").attr("data-id"),p="",f={"rich-messages":{}},m=0==a()?{profile_image:["",""],first_name:["",""],last_name:["",""],email:["",""],password:["",""],user_type:["",""]}:{profile_image:[a().image,""],first_name:[a().get("first_name"),""],last_name:[a().get("last_name"),""],email:[a().email,""],password:["",""],user_type:["",""]},v={},b=e(o),w="",S=!1,A=!1!==J.conversation,k={},C={};if(F.null(g))g=-1;else{let e=J.conversation.getMessage(g);p=e.message,(f=e.payload())["rich-messages"]||(f["rich-messages"]={})}switch(e(o).hasClass("sb-btn")||e(o).hasClass("sb-select")||e(o).hasClass("sb-submit")||(b=e(o).closest(".sb-btn,.sb-select")),e(s).find(".sb-info").html("").sbActive(!1),n){case"email":(v=Y.getAll(s)).first_name&&(m.user_type=["user",""],v.last_name||(m.last_name=["",""])),v.phone&&(k={phone:[v.phone[0],"Phone"]}),e.extend(m,v),t="Please fill in all required fields and make sure the email is valid.",u&&(u=i(u).replace("{user_email}",m.email[0]).replace("{user_name_}",m.first_name[0]+(v.last_name?" "+m.last_name[0]:""))),f["rich-messages"][h]={type:n,result:v},f.event="update-user",d={function:"update-user-and-message",settings:m,settings_extra:k,payload:f},S={settings:m,settings_extra:k};break;case"registration":if(k=Y.getAll(s.find(".sb-form-extra")),e.extend(m,Y.getAll(s.find(".sb-form-main"))),C=e.extend({},m),u&&(u=i(u)),M.registration_details){u+='[list values="';for(var l in m){let e=m[l][0].replace(/:|,/g,"");e&&("profile_image"==l&&(e=e.substr(e.lastIndexOf("/")+1)),["password","password-check","envato-purchase-code"].includes(l)&&(e="********",C[l]="********"),u+=m[l][1]?`${i(m[l][1].replace(/:|,/g,""))}:${e},`:"")}for(var l in k)k[l][0]&&(u+=`${i(k[l][1].replace(/:|,/g,""))}:${k[l][0].replace(/:|,/g,"")},`);u=u.slice(0,-1)+'"]'}m.user_type=["user",""],f["rich-messages"][h]={type:n,result:{user:C,extra:k}},f.event="update-user",d={function:a()?"update-user-and-message":"add-user-and-login",settings:m,settings_extra:k,payload:f},t=Y.getRegistrationErrorMessage(s),S={settings:m,settings_extra:k};break;case"rating":let r=e(o).attr("data-rating"),c=J.conversation.getLastUserMessage(!1,!0);u=i("positive"==r?u||i("Helpful"):e(o).closest(".sb-rating").attr("data-success-negative")),v={conversation_id:J.conversation.id,agent_id:c?c.get("user_id"):_,user_id:a().id,message:s.find("textarea").val(),rating:"positive"==r?1:-1},f["rich-messages"][h]={type:n,result:v},d={function:"set-rating",payload:f,settings:v},w=r;break;case"chips":case"select":case"buttons":v=F.escape(e(o).html()),u&&(u=i(u)+` *${v}*`),f["rich-messages"][h]={type:n,result:v},d={function:"update-message",payload:f},w=v,"chips"==n&&(J.sendMessage(a().id,v,[],!1,{id:h,event:"chips-click",result:v},"sb-human-takeover"==h&&0==b.index()&&2),"sb-human-takeover"==h&&0==e(o).index()&&Q.dialogflow.humanTakeover(),e(o).closest(".sb-content").remove());break;case"inputs":if(v=Y.getAll(s),t="All fields are required.",u){u=i(u)+' [list values="';for(var l in v)u+=`${i(v[l][1].replace(/:|,/g,""))}:${v[l][0].replace(/:|,/g,"")},`;u=u.slice(0,-1)+'"]'}f["rich-messages"][h]={type:n,result:v},d={function:"update-message",payload:f},S={settings:v}}if(c=p.substr(p.indexOf("["+n)),c=c.substr(0,c.indexOf("]")+1),t&&Y.errors(s))return Y.showErrorMessage(s,t),b.sbLoading(!1),(J.dashboard||A&&J.conversation.getLastMessage().id==g)&&J.scrollBottom(),!1;if(!u&&"registration"!=n){let e=this.shortcode(c),t=e[1].title?`title="${e[1].title}"`:"",s=e[1].message?`message="${e[1].message}"`:"",i="";if(["inputs","email"].includes(n)){for(var l in v)i+=v[l][0]+",";i=`values="${i.slice(0,-1)}"`}else i=`options="${v}"`;u=`[${"email"==n?"inputs":n} ${t} ${s} ${i} disabled="true"]`}-1!=g&&(u=u.replace(/<br>/g,"\n"),e.extend(d,{message_id:g,message:p?p.replace(c,u):u,payload:f})),F.ajax(d,t=>{if(t&&!F.errorValidation(t)){switch(n){case"email":for(var i in m)a().set(i,m[i][0]);for(var i in k)a().setExtra(i,k[i][0]);F.loginCookie(t[1]),"sb-subscribe-form"==h&&F.ajax({function:"subscribe-email",email:a().email}),J.automations.runAll(),F.event("SBNewEmailAddress",{id:h,name:a().name,email:a().email});break;case"registration":if(F.loginCookie(t[1]),m.id=[t[0].id],a()){for(var i in m)a().set(i,m[i][0]);for(var i in k)a().setExtra(i,k[i][0]);J.automations.runAll()}else{a(new z(t[0]));for(var i in k)a().setExtra(i,k[i][0]);W.start(),J.initChat(),M.init_dashboard&&r.find(".sb-departments-list").length||!u||J.sendMessage(_,u,[],!1,!1,3)}J.dashboard&&(r.removeClass("sb-init-form-active"),e(s).remove(),J.isInitDashboard()||J.hideDashboard()),M.wp_registration&&m.email&&m.password?Q.wordpress.ajax("wp-registration",{user_id:t[0].id,first_name:t[0].first_name,last_name:t[0].last_name,password:m.password[0],email:m.email[0]}):"wp"==M.wp_users_system&&Q.wordpress.ajax("wp-login",{user:m.email[0],password:m.password[0]}),delete this.cache.registration,setTimeout(()=>{F.event("SBRegistrationForm",{id:h,conversation_id:!!J.conversation&&J.conversation.id,user:m,extra:f["rich-messages"][h].result.extra})},5e3);break;case"buttons":J.scrollBottom()}-1==g?e(o).closest(".sb-rich-message").html(u):f.type&&"close-message"==f.type||y||J.setConversationStatus(2),["login","chips","rating"].includes(n)||!M.dialogflow_send_user_details&&["email","registration"].includes(n)||Q.dialogflow.message(`${h}${w?"|"+w:""}`,[],!1,S),!M.slack_active||y&&!Q.dialogflow.humanTakeoverActive()||J.slackMessage(a().id,a().name,a().image,u),W.active&&J.update(),"registration"!=n&&"email"!=n&&F.event("SBRichMessageSubmit",{result:t,data:f["rich-messages"][h],id:h})}else Y.showErrorMessage(s,Y.getRegistrationErrorMessage(t,"response")),J.dashboard&&J.scrollBottom(),b.sbLoading(!1)})}},shortcode:function(t){let s={},i=t.includes(" ")?t.substr(1,t.indexOf(" ")-1):t.slice(1,-1);if(/\?|"|'|`|\*/gi.test(i))return[!1,!1];let a=(t=t.slice(1,-1).substr(i.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].includes("=")){let t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)];s[e.trim(t[0])]=t[1].replace(/"/g,"")}return[i,s]},initInputs:function(t){return(t=e(e.parseHTML("<div>"+t+"</div>"))).find(".sb-input input").each(function(){e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")}),t.html()},timetable:function(t){let s=e(e.parseHTML(`<div>${t}</div>`)),a=s.find("[data-offset]").attr("data-offset");return a=F.null(a)?0:parseInt(a),s.find("[data-time]").each(function(){let n=e(this).attr("data-time").split("|");t="";for(var o=0;o<n.length;o++){if("closed"==n[o]){t+=i("Closed");break}if(n[o]){let e=n[o].split(":"),s=F.convertUTCDateToLocalDate(`01/01/2000 ${e[0]}:${e[1]}`,a);t+=s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==o||2==o?`<span>${i("to")}</span>`:1==o&&n[o+1]?"<br />":"")}}s.find(" > div > span").html(`<i class="sb-icon-clock"></i> ${i("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),e(this).html(t)}),s.html()},sliderChange:function(e,t="left"){let s=u.find(`#${e}`);if(s.length&&!s.hasClass("sb-moving")){let e=s.find(".sb-slider > div > div"),i=e.eq(0),a=Math.ceil(i.closest(".sb-slider").width()),n="right"==t?-1:1,o=parseFloat(parseFloat(parseFloat(i.css("margin-left"))+a*n).toFixed(2))+-.5*n,r=a*(e.length-1)*-1;o<1&&o>=r&&(i.css("margin-left",o+"px"),s.addClass("sb-moving"),setTimeout(()=>{s.removeClass("sb-moving")},1200)),s.find(".sb-icon-arrow-right").sbActive(!(r>o-15&&r<o+15)),s.find(".sb-icon-arrow-left").sbActive(o<-10)}},calendly:{script_loaded:!1,load:function(t,s,a){t=t.split("|"),this.script_loaded?this.load_(t[0],s):e.getScript("https://assets.calendly.com/assets/external/widget.js",()=>{this.script_loaded=!0,window.addEventListener("message",function(e){"https://calendly.com"===e.origin&&"calendly.event_scheduled"==e.data.event&&(J.updateMessage(a,i(t[1]?t[1]:"Booking completed.")),r.find(".sb-overlay-panel").sbActive(!1))}),this.load_(t[0],s)},!0)},load_:function(e,t){let s=r.find(".sb-overlay-panel");Calendly.initInlineWidget({url:(e.includes("http")?"":"https://")+e+"?hide_landing_page_details=1&hide_event_type_details=1&hide_gdpr_banner=1",parentElement:s.find("div").eq(1),prefil:"user"==a().type?{name:a().name,email:a().email}:{}}),s.attr("data-id","calendly"),s.find("div").eq(0).html(`<div>${i(t)}</div><i class="sb-btn-icon sb-icon-close"></i>`),s.sbActive(!0)}}},Y={getAll:function(t){let s={};return e(t).find(".sb-input[id]").each((t,i)=>{s[e(i).attr("id")]=this.get(i)}),s},get:function(t){let s=(t=e(t)).data("type"),a=i(F.escape(t.find(" > span").html()));switch(s){case"image":let e=t.find(".image").attr("data-value");return[F.null(e)?"":e,a];case"select":return[F.escape(t.find("select").val()),a];case"select-input":let i=t.find("select,input[disabled]"),n=i.val();return[F.escape((i.is("select")||i.is("input")?n:t.find("> div").html())+t.find('input[type="tel"]').val()),a];default:let o=t.find("input");return[F.escape(o.length?o.val():t.find("[data-value]").attr("data-value")),a]}},set:function(t,s){if((t=e(t)).length){switch(t.data("type")){case"image":s?t.find(".image").attr("data-value",s).css("background-image",`url("${s}")`):t.find(".image").removeAttr("data-value").removeAttr("style");break;case"select":t.find("select").val(s);break;default:t.find("input,textarea").val(s)}return!0}return!1},clear:function(t){e(t).find(".sb-input,.sb-input-setting").each((t,s)=>{this.set(s,""),e(s).find("input, select, textarea").removeClass("sb-error")}),this.set(e(t).find("#user_type"),"user")},errors:function(t){let s=!1,i=e(t).find("input, select, textarea").removeClass("sb-error");return i.each(function(t){let a=e.trim(e(this).val()),n=e(this).attr("type"),o=e(this).prop("required");(o&&!a||(o||a)&&("password"==n&&(a.length<8||i.length>t+1&&"password"==i.eq(t+1).attr("type")&&i.eq(t+1).val()!=a)||"email"==n&&(a.indexOf("@")<0||a.indexOf(".")<0||/;|:|\/|\\|,|#|"|!|=|\+|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(a))||"tel"==n&&a&&(!e(this).parent().find("select").val()&&!e(this).parent().find("div").html().trim().startsWith("+")||isNaN(a)||a.includes("+")||a.length<5)))&&(s=!0,e(this).addClass("sb-error"))}),(i=e(t).find("[data-required]").removeClass("sb-error")).each(function(){F.null(e(this).attr("data-value"))&&(e(this).addClass("sb-error"),s=!0)}),s},showErrorMessage:function(t,s){e(t).find(".sb-info").html(i(s)).sbActive(!0),clearTimeout(k),k=setTimeout(function(){e(t).find(".sb-info").sbActive(!1)},7e3)},showSuccessMessage:function(t,s){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${s}</div>`)},getRegistrationErrorMessage(t,s="validation"){if("response"==s)return F.errorValidation(t,"duplicate-email")?"This email is already in use. Please use another email.":F.errorValidation(t,"duplicate-phone")?"This phone number is already in use. Please use another number.":F.errorValidation(t,"invalid-envato-purchase-code")?"Invalid Envato purchase code.":"Error. Please check your information and try again.";let i=e(t).find("#last_name").length?"First name, last name":"Name",a=e(t).find("#phone [required]").length?", phone number":"",n=e(t).find("#email").length?", email":"",o=e(t).find("#password").length?", and a password (8 character minimum)":"";return`${i}${n}${a}${o} ${n+a+o?"are":"is"} required.`}};window.SBForm=Y;var Q={login:function(){return this.is("wp")&&typeof SB_WP_ACTIVE_USER!=D&&"wp"==M.wp_users_system?[[SB_WP_ACTIVE_USER,typeof SB_WP_AVATAR!=D?SB_WP_AVATAR:""],"wp"]:typeof SB_PERFEX_ACTIVE_USER!=D?[[SB_PERFEX_ACTIVE_USER,SB_PERFEX_CONTACT_ID],"perfex"]:typeof SB_WHMCS_ACTIVE_USER!=D?[SB_WHMCS_ACTIVE_USER,"whmcs"]:typeof SB_AECOMMERCE_ACTIVE_USER!=D?[SB_AECOMMERCE_ACTIVE_USER,"aecommerce"]:!(typeof SB_DEFAULT_USER==D||!SB_DEFAULT_USER)&&[SB_DEFAULT_USER,"default"]},is:function(e){return S?SBAdmin.apps.is(e):"wordpress"==e||"wp"==e?M.wp:e in M&&M[e]},wordpress:{ajax:function(t,s,i=!1){typeof SB_WP_AJAX_URL!=D&&e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},s)}).done(e=>{i&&i(e)})}},woocommerce:{updateCart:function(e,t,s=!1){Q.wordpress.ajax(e,{product_id:t},s)},waitingList:function(e="request",t=!1){typeof SB_WP_WAITING_LIST!==D&&("request"!=e||SB_WP_WAITING_LIST&&F.storageTime("waiting-list-"+SB_WP_PAGE_ID,24))&&a()&&F.ajax({function:"woocommerce-waiting-list",product_id:!1===t?SB_WP_PAGE_ID:t,conversation_id:J.conversation.id,action:e,token:this.token},t=>{t&&(F.storageTime("waiting-list-"+SB_WP_PAGE_ID),"request"!=e||J.chat_open&&!J.dashboard||J.updateConversations())})}},dialogflow:{token:s("dialogflow-token"),typing_enabled:!1,project_id:!1,message:function(t="",i=[],n=!1,o=!1){if(!(t.length<2)||i.length)if(this.active(!0,!0,!1)){let e=Q.dialogflow.humanTakeoverActive();if(e&&!this.typing_enabled||this.typing(),this.chatbotLimit())return J.sendMessage(_,this.chatbotLimit());setTimeout(()=>{let n=J.conversation;F.ajax({function:"dialogflow-message",conversation_id:!!n&&n.id,message:t,attachments:i,parameters:o,token:this.token,dialogflow_language:s("dialogflow-language")?s("dialogflow-language"):SB_LANG,project_id:this.project_id,session_id:a().id+"-"+n.id},i=>{if(!1!==i){if(i.response&&i.response.error)return console.error(i.response);if(i.human_takeover)return J.offlineMessage(),J.followUp(),this.active(!1);if(i.language_detection&&!s("dialogflow-language")&&s("dialogflow-language",[i.language_detection]),i.user_language&&!s("dialogflow-language")&&a().setExtra("language",i.user_language),i.translations&&(M.translations=i.translations),!F.errorValidation(i)){let r=!!i.response.queryResult&&i.response.queryResult,l=r&&("input.unknown"==r.action||r.match&&"NO_MATCH"==r.match.matchType),c=i.messages&&Array.isArray(i.messages)?i.messages:[];if(J.typing(-1,"stop"),clearTimeout(k),this.token!=i.token&&(this.token=i.token,s("dialogflow-token",i.token)),l?e&&(this.typing_enabled=!1):this.typing_enabled=!0,r){if(r.action){let e=r.action;"end"==e&&this.active(!1),F.event("SBBotAction",e)}for(o=0;o<c.length;o++){if(c[o].payload){let e=["human-takeover","redirect","woocommerce-update-cart","woocommerce-checkout","open-article","transcript","department","agent","send-email","disable-bot","rich-message"],t=c[o].payload;if(F.null(t)&&(t=[]),e[0]in t&&!0===t[e[0]]&&this.humanTakeover(),e[1]in t&&setTimeout(function(){t["new-window"]?window.open(t[e[1]]):document.location=t[e[1]]},500),e[2]in t){let s=t[e[2]];Q.woocommerce.updateCart(s[0],s[1],e=>{e&&F.event("SBWoocommerceCartUpdated",{action:s[0],product:s[1]})})}if(e[3]in t&&!0===t[e[3]]&&Q.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(()=>document.location=e,500)}),e[4]in t&&J.showArticles(t[e[4]]),e[5]in t&&t[e[5]]&&F.ajax({function:"transcript",conversation_id:n.id,type:"txt"},s=>{"email"==t[e[5]]&&a().email?J.sendEmail(t.message?t.message:"",[[s,s]],n.id):window.open(s)}),e[6]in t&&F.ajax({function:"update-conversation-department",conversation_id:n.id,department:t[e[6]],message:n.getLastUserMessage().message}),e[7]in t&&F.ajax({function:"update-conversation-agent",conversation_id:n.id,agent_id:t[e[7]],message:n.getLastUserMessage().message}),e[8]in t){let s=t[e[8]];J.sendEmail(s.message,s.attachments,"active_user"==s.recipient)}e[9]in t&&(this.active(!1),F.cookie("sb-dialogflow-disabled",!0,300,"set",!0)),e[10]in t&&J.sendMessage(_,t[e[10]]),F.event("SBBotPayload",t)}this.chatbotLimit(!1),s("dialogflow-language")||!r.languageCode||SB_LANG&&r.languageCode==SB_LANG[0]||s("dialogflow-language",[r.languageCode])}if(r.diagnosticInfo){r.diagnosticInfo.end_conversation&&this.active(!1)}}if(M.slack_active&&c&&(!y||e))for(var o=0;o<c.length;o++)J.slackMessage(a().id,M.bot_name,M.bot_image,c[o].message,c[o].attachments);F.event("SBBotMessage",{response:i,message:t})}}})},!1!==n?n:0==M.bot_delay?2e3:parseInt(M.bot_delay))}else this.active(!0,!1,!0)&&!e(".sb-emoji-list").html().includes("<li>"+t+"</li>")&&this.openAI(t)},openAI:function(e,t=!1){M.open_ai_active&&(this.typing_enabled=!0,this.typing(),setTimeout(()=>{F.ajax({function:"open-ai-message",message:e,conversation_id:!!J.conversation&&J.conversation.id,extra:{token:Q.dialogflow.token}},i=>{J.typing(-1,"stop"),F.event("SBOpenAIMessage",{response:i,message:e}),i&&i[0]?(M.chatbot_limit&&this.chatbot_limit++,M.slack_active&&J.slackMessage(a().id,M.bot_name,M.bot_image,i[1]),i[2]&&Q.dialogflow.token!=i[2]&&(Q.dialogflow.token=i.token,s("dialogflow-token",i.token)),i[3]&&(J.offlineMessage(),J.followUp())):F.error(i[1].error?i[1].error.message:i[1],"SBApps.dialogflow.openAI"),t&&t(i)})},0==M.bot_delay?2e3:parseInt(M.bot_delay)))},typing:function(){clearTimeout(C),C=setTimeout(()=>{J.typing(-1,"start"),setTimeout(()=>{J.typing(-1,"stop")},3e4)},1e3)},active:function(e=!0,t=!0,s=!0){let i="human-takeover-"+J.conversation.id;if(!1===e)return F.storageTime(i),!1;"activate"==e&&(F.cookie("sb-dialogflow-disabled",0,0,"delete"),F.storage(i,""));let a=!S&&!F.cookie("sb-dialogflow-disabled")&&(F.storageTime(i,240)||!J.agent_online)&&(!M.dialogflow_office_hours||!M.office_hours);return!(!S&&Q.dialogflow.humanTakeoverActive()&&M.dialogflow_human_takeover_disable_chatbot)&&(t&&s?(M.dialogflow_active||M.open_ai_active)&&a:(!t||M.dialogflow_active)&&(!s||M.open_ai_active)&&a)},welcome:function(e=!1,t=!1){F.ajax({function:"dialogflow-message",message:"",conversation_id:J.conversation.id,token:this.token,event:"Welcome",dialogflow_language:s("dialogflow-language")?s("dialogflow-language"):SB_LANG},()=>{e&&J.start(),t&&J.audio.play()})},humanTakeover:function(){F.ajax({function:"dialogflow-human-takeover",conversation_id:J.conversation.id},()=>{J.offlineMessage(),J.followUp(),this.active(!1),M.queue_human_takeover&&(M.queue=!0,J.queue(J.conversation.id))})},humanTakeoverActive:function(){return!F.storageTime("human-takeover-"+(J.conversation?J.conversation.id:s("open-conversation")),240)},translate:function(e,t,s){F.ajax({function:"google-translate",strings:e,language_code:t,token:this.token},e=>{this.token=e[1],s(e[0])})},chatbotLimit:function(e=!0){if(M.chatbot_limit){let i=s("chatbot_limit"),a=(new Date).getTime()/1e3;if(i||(i=[]),e){let e=a-M.chatbot_limit.interval,n=[];for(var t=0;t<i.length;t++)i[t]>e&&n.push(i[t]);if(s("chatbot_limit",n),n.length>=M.chatbot_limit.quota)return M.chatbot_limit.message}else i.push(a),s("chatbot_limit",i)}return!1}},aecommerce:{cart:function(){Q.is("aecommerce")&&typeof SB_AECOMMERCE_CART!=D&&typeof SB_AECOMMERCE_ACTIVE_USER!=D&&s("aecommerce")!=JSON.stringify(SB_AECOMMERCE_CART)&&F.ajax({function:"aecommerce-cart",cart:SB_AECOMMERCE_CART},()=>{s("aecommerce",JSON.stringify(SB_AECOMMERCE_CART))})}},martfury:{privateChat:function(){let t=e("#tab-vendor > h4,.ps-product__vendor > a");if(t.length){t=t.html().toLowerCase();for(var s=0;s<M.martfury.length;s++)if(t==M.martfury[s]["martfury-linking-store"].toLowerCase()){let e=M.martfury[s]["martfury-linking-agent"],t=F.activeUser()?F.activeUser().conversations:[];J.default_agent=e;for(var i=0;i<t.length;i++)if(t[i].get("agent_id")==e)return void J.openConversation(t[i].id);J.clear(),J.hideDashboard()}}}}};window.SBApps=Q,e(document).ready(function(){if((r=e(".sb-admin, .sb-admin-start")).length)return S=!0,void o();let t,s,i=!1;if(typeof SB_INIT_URL!=D)SB_INIT_URL.indexOf(".js")<0&&(SB_INIT_URL+="/js/main.js?v=3.6.5"),t=SB_INIT_URL;else{let e=document.getElementsByTagName("script"),s=["init.js","main.js","min/init.min.js","min/main.min.js"];for(var a=0;a<e.length;a++){let o=e[a].src;if("sbinit"==e[a].id){t=o,i=i||t.includes("init.");break}for(var n=0;n<s.length;n++)if(o&&o.includes("/supportboard/js/"+s[n])){t=o,i=i||t.includes("init.");break}}}let l=F.getURL(!1,t);if(l.url&&(t=l.url),typeof SB_DISABLED!=D&&SB_DISABLED)return;if(i)return void o();typeof SB_TICKETS==D&&"tickets"!=l.mode||(A=!0,l.mode="tickets"),l.cloud&&(q=l.cloud);let c=t.lastIndexOf("main.min.js"),d=(s=t.substr(0,t.lastIndexOf("main.js")>0?t.lastIndexOf("main.js")-4:c-8))+"/include/init.php"+(l.lang?"?lang="+l.lang:"")+(l.mode?"&mode="+l.mode:"")+(q?"&cloud="+q:"");F.cors("GET",d.replace(".php&",".php?"),t=>{let i="body";A&&e("#sb-tickets").length&&(i="#sb-tickets"),e(i).append(t),F.loadResource(s+"/css/"+(A?"tickets":"main")+".css"),A?F.loadResource(s+"/apps/tickets/tickets"+(c>0?".min":"")+".js?v=3.6.5",!0,()=>{o()}):o(),l.lang&&(SB_LANG=[l.lang,S?"admin":"front"])})})}(jQuery);